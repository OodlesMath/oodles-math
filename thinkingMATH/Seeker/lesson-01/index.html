<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Bunny Festival - Kids Adventure</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #fdf4ff; 
            margin: 0;
            overflow-x: hidden;
        }
        
        .game-container-outer {
            background: #ffffff;
            border-radius: 60px;
            padding: 15px;
            box-shadow: 0 35px 70px -15px rgba(255, 105, 180, 0.3);
            border: 12px solid #fbcfe8; 
            min-height: 350px;
        }

        .game-wrapper {
            background: linear-gradient(to bottom, #7dd3fc 0%, #ffffff 100%);
            border-radius: 45px;
            position: relative;
            overflow: hidden;
            height: 250px;
        }

        .instruction-bar {
            background: linear-gradient(90deg, #f472b6, #fb7185);
            border-radius: 0 0 45px 45px;
            padding: 16px;
            text-align: center;
            color: white;
            font-weight: 800;
            font-size: 18px;
            box-shadow: inset 0 -4px 0 rgba(0,0,0,0.1);
        }

        .key-hint {
            background: #ffffff;
            color: #db2777;
            padding: 3px 14px;
            border-radius: 15px;
            margin: 0 6px;
            font-size: 14px;
            box-shadow: 0 4px 0 #f9a8d4;
        }

        @keyframes bunny-float {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-12px) rotate(2deg); }
        }
        .cute-logo { animation: bunny-float 3s infinite ease-in-out; }

        input[type=range] { accent-color: #ec4899; }

        #game-summary {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            z-index: 100;
            border: 6px solid #f472b6;
            min-width: 320px;
        }
    </style>
</head>
<body class="text-gray-900">

    <header class="bg-white shadow-sm border-b-4 border-pink-100">
        <div class="max-w-7xl mx-auto px-4 h-24 flex justify-between items-center">
            <div class="flex items-center space-x-4 cute-logo cursor-pointer">
                <svg width="55" height="55" viewBox="0 0 24 24">
                    <path d="M12 22c4.418 0 8-3.582 8-8s-3.582-8-8-8-8 3.582-8 8 3.582 8 8 8z" fill="#fb7185"/>
                    <path d="M7 2c0 0-3 1-3 6s2 8 4 8 3-4 3-8-4-6-4-6z" fill="#f472b6"/>
                    <path d="M17 2c0 0 3 1 3 6s-2 8-4 8-3-4-3-8 4-6 4-6z" fill="#f472b6"/>
                    <circle cx="9" cy="13" r="1.5" fill="white"/>
                    <circle cx="15" cy="13" r="1.5" fill="white"/>
                </svg>
                <div class="text-3xl font-black text-pink-600 tracking-tighter uppercase">Happy <span class="text-blue-400">Bunny</span></div>
            </div>
            <div class="bg-blue-100 px-6 py-2 rounded-full border-2 border-blue-200 text-blue-600 font-black text-sm shadow-sm">
                ADVENTURE TIME! üéÜ
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-10 px-4">
        
        <div class="game mb-10 relative">
            <div class="game-container-outer">
                <div class="game-wrapper" id="canvas-container">
                    <!-- Canvas container for injection -->
                    <div class="interstitial-wrapper w-full h-full" style="min-height: 250px;"></div>
                    
                    <div id="game-summary">
                        <h3 class="text-pink-600 text-3xl font-black mb-1">BRAVO!</h3>
                        <p class="text-gray-500 font-bold mb-4">You are a Super Star!</p>
                        <div class="bg-pink-50 rounded-2xl p-4 mb-6">
                            <div class="text-sm font-bold text-pink-400">YOUR SCORE</div>
                            <div id="final-score" class="text-5xl font-black text-pink-600">00000</div>
                        </div>
                        <button id="restart-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-black py-3 px-8 rounded-2xl shadow-lg transition-transform active:scale-95">
                            PLAY AGAIN ü•ï
                        </button>
                    </div>
                </div>
                
                <div class="instruction-bar">
                    <span class="opacity-95 text-white">Press</span>
                    <span class="key-hint">SPACE</span>
                    <span class="opacity-95 text-white">or</span>
                    <span class="key-hint">TAP SCREEN</span>
                    <span class="opacity-95 text-white">to Jump!</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-10 rounded-[50px] shadow-xl border-b-8 border-pink-100">
                <h2 class="text-xl font-black text-gray-700 mb-8 flex items-center">
                    <span class="mr-3 text-2xl">üé®</span> Parents Zone
                </h2>
                
                <form id="settings-form" class="space-y-8">
                    <div class="space-y-3">
                        <div class="flex justify-between font-black text-pink-500 uppercase text-xs">
                            <label>Bunny Speed</label>
                            <span id="speed-val">7.0</span>
                        </div>
                        <input type="range" name="SPEED" min="5" max="15" step="0.5" class="w-full h-3 bg-pink-50 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between font-black text-blue-500 uppercase text-xs">
                            <label>Jump Power</label>
                            <span id="gravity-val">0.6</span>
                        </div>
                        <input type="range" name="GRAVITY" min="0.3" max="1.0" step="0.05" class="w-full h-3 bg-blue-50 rounded-lg appearance-none cursor-pointer">
                    </div>
                    <div class="text-center">
                        <button type="reset" class="text-[10px] font-bold text-gray-300 hover:text-pink-500 uppercase tracking-widest">Reset Default</button>
                    </div>
                </form>
            </div>

            <div class="bg-gradient-to-br from-pink-500 to-rose-600 p-10 rounded-[50px] shadow-xl text-white flex flex-col justify-center items-center text-center border-b-8 border-rose-800">
                <div class="text-6xl mb-3 drop-shadow-md">üèÜ</div>
                <div class="text-sm font-black opacity-90 uppercase tracking-widest mb-1">Super Best</div>
                <div id="high-score-display" class="text-6xl font-black tracking-tighter drop-shadow-lg">00000</div>
                <div id="save-status" class="mt-6 text-xs font-bold bg-white text-pink-600 px-4 py-2 rounded-full hidden shadow-lg">‚ú® SAVED!</div>
            </div>
        </div>

        <div class="mt-12 text-center text-xs text-gray-300 font-bold uppercase tracking-widest">
            Magic ID: <span id="user-display">...</span>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Safe Firebase initialization
        let db, auth, appId;
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'bunny-festival-v3';
        } catch (e) {
            console.warn("Firebase not available, using offline mode.");
        }

        // --- Realistic Particle for Fireworks ---
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.velocity = {
                    x: (Math.random() - 0.5) * 12,
                    y: (Math.random() - 0.5) * 12
                };
                this.alpha = 1;
                this.friction = 0.95;
                this.gravity = 0.2;
            }
            draw(ctx) {
                ctx.save();
                ctx.globalAlpha = this.alpha;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, Math.random() * 4 + 1, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
            update() {
                this.velocity.x *= this.friction;
                this.velocity.y *= this.friction;
                this.velocity.y += this.gravity;
                this.x += this.velocity.x;
                this.y += this.velocity.y;
                this.alpha -= 0.01;
            }
        }

        function Runner(containerSelector, config) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            this.container = container;
            this.config = Object.assign({
                SPEED: 7,
                GRAVITY: 0.6,
                INITIAL_JUMP_VELOCITY: 13,
                ACCELERATION: 0.001
            }, config);
            this.init();
        }

        Runner.prototype = {
            init: function() {
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = 800;
                this.canvas.height = 250;
                this.container.appendChild(this.canvas);

                this.bunny = { x: 100, y: 170, vy: 0, jumping: false, width: 70, height: 75 };
                this.obstacles = [];
                this.clouds = [];
                this.fireworks = [];
                this.score = 0;
                this.highScore = 0;
                this.isGameOver = false;
                this.isStarted = false;
                this.frameCount = 0;

                this.bindEvents();
                this.gameLoop();
                this.resize();
            },
            bindEvents: function() {
                const handleInput = (e) => {
                    if (e && e.type === 'keydown' && e.code !== 'Space' && e.code !== 'ArrowUp') return;
                    if (this.isGameOver) return; 
                    if (!this.isStarted) return this.isStarted = true;
                    this.jump();
                };
                window.addEventListener('keydown', handleInput);
                this.canvas.addEventListener('mousedown', handleInput);
                this.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(); });
                document.getElementById('restart-btn').addEventListener('click', () => this.restart());
                window.addEventListener('resize', () => this.resize());
            },
            resize: function() {
                this.canvas.style.width = '100%';
                this.canvas.style.height = 'auto';
            },
            jump: function() {
                if (!this.bunny.jumping) {
                    this.bunny.vy = -this.config.INITIAL_JUMP_VELOCITY;
                    this.bunny.jumping = true;
                }
            },
            restart: function() {
                document.getElementById('game-summary').style.display = 'none';
                this.bunny.y = 170;
                this.bunny.vy = 0;
                this.bunny.jumping = false;
                this.obstacles = [];
                this.fireworks = [];
                this.score = 0;
                this.isGameOver = false;
                this.isStarted = true;
            },
            spawnFirework: function() {
                const x = 150 + Math.random() * 500;
                const y = 50 + Math.random() * 100;
                const colors = ['#ff477e', '#3b82f6', '#fde047', '#4ade80', '#c084fc'];
                for(let i=0; i<40; i++) {
                    this.fireworks.push(new Particle(x, y, colors[Math.floor(Math.random()*colors.length)]));
                }
            },
            update: function() {
                if (!this.isStarted) return;
                
                if (this.isGameOver) {
                    this.fireworks.forEach((p, idx) => {
                        p.update();
                        if(p.alpha <= 0) this.fireworks.splice(idx, 1);
                    });
                    if(this.frameCount % 20 === 0) this.spawnFirework();
                    this.frameCount++;
                    return;
                }

                this.frameCount++;
                this.score += 0.15;

                this.bunny.y += this.bunny.vy;
                this.bunny.vy += this.config.GRAVITY;
                if (this.bunny.y > 170) {
                    this.bunny.y = 170;
                    this.bunny.vy = 0;
                    this.bunny.jumping = false;
                }

                if (this.frameCount % Math.max(90, Math.floor(180 - this.config.SPEED * 6)) === 0) {
                    this.obstacles.push({ x: 800, y: 175, w: 55, h: 65 });
                }
                
                if (this.frameCount % 180 === 0) {
                    this.clouds.push({ x: 800, y: 30 + Math.random() * 40, parts: this.generateCloudParts() });
                }

                this.obstacles.forEach(o => {
                    o.x -= this.config.SPEED;
                    if (this.bunny.x + 20 < o.x + o.w - 20 && this.bunny.x + this.bunny.width - 20 > o.x + 20 && 
                        this.bunny.y + 20 < o.y + o.h - 5 && this.bunny.y + this.bunny.height - 10 > o.y + 5) {
                        this.isGameOver = true;
                        this.showSummary();
                    }
                });
                
                this.clouds.forEach(c => c.x -= this.config.SPEED * 0.15);
                this.obstacles = this.obstacles.filter(o => o.x > -120);
                this.clouds = this.clouds.filter(c => c.x > -200);
            },
            generateCloudParts: function() {
                let parts = [];
                for(let i=0; i<6; i++) {
                    parts.push({ dx: i * 14, dy: Math.sin(i)*10, r: 18 + Math.random() * 12 });
                }
                return parts;
            },
            showSummary: function() {
                const summary = document.getElementById('game-summary');
                const finalScore = document.getElementById('final-score');
                finalScore.textContent = Math.floor(this.score).toString().padStart(5, '0');
                summary.style.display = 'block';
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    document.getElementById('high-score-display').textContent = Math.floor(this.highScore).toString().padStart(5, '0');
                }
            },
            draw: function() {
                this.ctx.clearRect(0, 0, 800, 250);

                // --- LUXURY SUN ---
                const sunX = 80, sunY = 60;
                this.ctx.save();
                this.ctx.shadowBlur = 20;
                this.ctx.shadowColor = '#facc15';
                const sunGrad = this.ctx.createRadialGradient(sunX, sunY, 5, sunX, sunY, 40);
                sunGrad.addColorStop(0, '#ffffff');
                sunGrad.addColorStop(0.3, '#fef08a');
                sunGrad.addColorStop(1, '#facc15');
                this.ctx.fillStyle = sunGrad;
                this.ctx.beginPath();
                this.ctx.arc(sunX, sunY, 35, 0, Math.PI * 2);
                this.ctx.fill();
                this.ctx.restore();
                
                this.ctx.strokeStyle = 'rgba(253, 216, 53, 0.4)';
                this.ctx.lineWidth = 6;
                for(let i=0; i<10; i++) {
                    const angle = (i / 10) * Math.PI * 2 + (this.frameCount * 0.015);
                    this.ctx.beginPath();
                    this.ctx.moveTo(sunX + Math.cos(angle) * 48, sunY + Math.sin(angle) * 48);
                    this.ctx.lineTo(sunX + Math.cos(angle) * 58, sunY + Math.sin(angle) * 58);
                    this.ctx.stroke();
                }

                // Meadow
                this.ctx.fillStyle = '#4ade80';
                this.ctx.fillRect(0, 220, 800, 30);
                this.ctx.fillStyle = '#22c55e';
                this.ctx.fillRect(0, 220, 800, 6);

                // REAL Fluffy Clouds
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.96)';
                this.ctx.shadowBlur = 10;
                this.ctx.shadowColor = 'rgba(0,0,0,0.05)';
                this.clouds.forEach(c => {
                    c.parts.forEach(p => {
                        this.ctx.beginPath();
                        this.ctx.arc(c.x + p.dx, 50 + p.dy, p.r, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                });
                this.ctx.shadowBlur = 0;

                // --- DETAILED BUNNY ---
                const bx = this.bunny.x;
                const by = this.bunny.y;
                const jumping = this.bunny.jumping;

                this.ctx.save();
                if(jumping) this.ctx.rotate(-0.08);

                // Ears
                this.ctx.fillStyle = '#fb7185';
                const earY = jumping ? by + 5 : by + 12;
                this.ctx.beginPath(); 
                this.ctx.ellipse(bx + 18, earY, 12, 35, 0.25, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.beginPath(); 
                this.ctx.ellipse(bx + 45, earY, 12, 35, -0.25, 0, Math.PI * 2); this.ctx.fill();
                // Inner ears
                this.ctx.fillStyle = '#fda4af';
                this.ctx.beginPath();
                this.ctx.ellipse(bx + 18, earY + 5, 6, 25, 0.25, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.beginPath();
                this.ctx.ellipse(bx + 45, earY + 5, 6, 25, -0.25, 0, Math.PI * 2); this.ctx.fill();

                // Body & Paws
                this.ctx.fillStyle = '#fb7185';
                if(jumping) {
                    this.ctx.beginPath(); this.ctx.ellipse(bx + 10, by + 68, 15, 8, 0.4, 0, Math.PI * 2); this.ctx.fill();
                } else {
                    const walk = Math.sin(this.frameCount * 0.4) * 8;
                    this.ctx.beginPath(); this.ctx.ellipse(bx + 15 + walk, by + 70, 10, 14, 0, 0, Math.PI * 2); this.ctx.fill();
                    this.ctx.beginPath(); this.ctx.ellipse(bx + 40 - walk, by + 70, 10, 14, 0, 0, Math.PI * 2); this.ctx.fill();
                }
                // Main body
                this.ctx.fillStyle = '#fb7185';
                this.ctx.beginPath();
                this.ctx.ellipse(bx + 32, by + 48, 35, 30, 0, 0, Math.PI * 2);
                this.ctx.fill();
                
                // Fluffy Tail
                this.ctx.fillStyle = '#ffffff';
                this.ctx.beginPath(); this.ctx.arc(bx + 4, by + 58, 12, 0, Math.PI * 2); this.ctx.fill();

                // Eyes & Face
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath(); this.ctx.arc(bx + 52, by + 42, 14, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.fillStyle = 'black';
                this.ctx.beginPath(); this.ctx.arc(bx + 58, by + 42, 7, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.fillStyle = 'white';
                this.ctx.beginPath(); this.ctx.arc(bx + 61, by + 39, 3.5, 0, Math.PI * 2); this.ctx.fill();
                // Pink blush
                this.ctx.fillStyle = 'rgba(255, 182, 193, 0.6)';
                this.ctx.beginPath(); this.ctx.ellipse(bx + 45, by + 55, 10, 6, 0, 0, Math.PI * 2); this.ctx.fill();
                // Nose
                this.ctx.fillStyle = '#f43f5e';
                this.ctx.beginPath(); this.ctx.arc(bx + 68, by + 52, 4.5, 0, Math.PI * 2); this.ctx.fill();
                this.ctx.restore();

                // --- REALISTIC MUSHROOMS ---
                this.obstacles.forEach(o => {
                    // 3D Stem
                    const stemG = this.ctx.createLinearGradient(o.x, o.y, o.x + 40, o.y);
                    stemG.addColorStop(0, '#fefce8'); stemG.addColorStop(1, '#fde68a');
                    this.ctx.fillStyle = stemG;
                    this.ctx.beginPath();
                    this.ctx.moveTo(o.x + 18, o.y + 25);
                    this.ctx.quadraticCurveTo(o.x + 25, o.y + 65, o.x + 15, o.y + 65);
                    this.ctx.lineTo(o.x + 40, o.y + 65);
                    this.ctx.quadraticCurveTo(o.x + 30, o.y + 65, o.x + 37, o.y + 25);
                    this.ctx.fill();

                    // Shaded Cap
                    const capG = this.ctx.createRadialGradient(o.x + 15, o.y + 10, 2, o.x + 25, o.y + 20, 40);
                    capG.addColorStop(0, '#f87171'); capG.addColorStop(1, '#b91c1c');
                    this.ctx.fillStyle = capG;
                    this.ctx.beginPath();
                    this.ctx.ellipse(o.x + 28, o.y + 18, 35, 25, 0, 0, Math.PI * 2);
                    this.ctx.fill();

                    // Realistic Spots
                    this.ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    this.ctx.beginPath(); this.ctx.arc(o.x + 15, o.y + 10, 8, 0, Math.PI * 2); this.ctx.fill();
                    this.ctx.beginPath(); this.ctx.arc(o.x + 45, o.y + 22, 6, 0, Math.PI * 2); this.ctx.fill();
                    this.ctx.beginPath(); this.ctx.arc(o.x + 28, o.y + 30, 5, 0, Math.PI * 2); this.ctx.fill();
                });

                // Fireworks
                this.fireworks.forEach(p => p.draw(this.ctx));

                // UI
                if (!this.isStarted) {
                    this.ctx.textAlign = 'center';
                    this.ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    this.ctx.roundRect(150, 100, 500, 90, 40);
                    this.ctx.fill();
                    this.ctx.fillStyle = '#db2777';
                    this.ctx.font = 'bold 45px "Poppins"';
                    this.ctx.fillText('CLICK TO START! üêæ', 400, 162);
                }
            },
            gameLoop: function() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }
        };

        async function init() {
            const form = document.getElementById('settings-form');
            const speedVal = document.getElementById('speed-val');
            const gravityVal = document.getElementById('gravity-val');
            const highScoreDisplay = document.getElementById('high-score-display');
            const userDisplay = document.getElementById('user-display');
            
            // Wait for DOM to be truly ready for canvas injection
            setTimeout(() => {
                const wrapper = document.querySelector('.interstitial-wrapper');
                if (!wrapper) return;
                const runner = new Runner('.interstitial-wrapper');
                setupLogic(runner);
            }, 100);

            async function setupLogic(runner) {
                function syncForm(cfg) {
                    if (!form) return;
                    for (let key in cfg) {
                        if (form.elements[key]) {
                            form.elements[key].value = cfg[key];
                            if (key === 'SPEED') speedVal.textContent = parseFloat(cfg[key]).toFixed(1);
                            if (key === 'GRAVITY') gravityVal.textContent = parseFloat(cfg[key]).toFixed(2);
                        }
                    }
                }

                if (auth && db) {
                    try {
                        const { user } = await signInAnonymously(auth);
                        userDisplay.textContent = user.uid.substring(0, 8);
                        const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'config');
                        const snap = await getDoc(docRef);
                        if (snap.exists()) {
                            const data = snap.data();
                            Object.assign(runner.config, data);
                            if (data.highScore) {
                                runner.highScore = data.highScore;
                                highScoreDisplay.textContent = Math.floor(data.highScore).toString().padStart(5, '0');
                            }
                        }
                        syncForm(runner.config);
                    } catch (e) { console.warn("Firebase sync disabled."); }
                }

                form.addEventListener('input', async (e) => {
                    const key = e.target.name;
                    const val = parseFloat(e.target.value);
                    if (!isNaN(val)) {
                        runner.config[key] = val;
                        if (key === 'SPEED') speedVal.textContent = val.toFixed(1);
                        if (key === 'GRAVITY') gravityVal.textContent = val.toFixed(2);
                        if (auth && auth.currentUser) {
                            await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'settings', 'config'), {
                                ...runner.config,
                                highScore: runner.highScore
                            });
                        }
                    }
                });
            }
        }

        // Initialize when window is fully loaded to prevent null element issues
        window.addEventListener('load', init);
    </script>
</body>
</html>
