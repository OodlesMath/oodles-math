<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Make Tens Addition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-sky: #87CEEB;
            --font-main: 'Poppins', sans-serif;
            
            /* Vibrant Colors (Oodles Style) */
            --c-red: #FF6B6B;
            --c-blue: #4ECDC4;
            --c-green: #95E1D3;
            --c-yellow: #FFE66D;
            --c-orange: #FFA500;
            --c-purple: #C39BD3;
            --c-white: #FFFFFF;
            --c-dark: #2c3e50;
            
            /* Block Colors */
            --block-ten: #4ECDC4; /* Teal */
            --block-one: #FFA500; /* Orange */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-sky);
            background-image: 
                radial-gradient(circle at 50% 50%, white 10px, transparent 11px),
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.6) 20px, transparent 21px),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.6) 30px, transparent 31px);
            background-size: 100px 100px, 200px 200px, 300px 300px;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: var(--c-dark);
        }

        /* --- Icons --- */
        .icon { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 3; stroke-linecap: round; stroke-linejoin: round; }
        
        /* --- Layout --- */
        #app {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            position: relative;
        }

        .hidden { display: none !important; }

        /* --- Header --- */
        header {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            margin-bottom: 10px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid white;
            z-index: 20;
        }

        .title-group h1 {
            color: var(--c-dark);
            font-size: 1.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
        }

        .controls { display: flex; align-items: center; gap: 10px; }

        .score-board {
            background: var(--c-blue);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 800;
            box-shadow: 0 4px 0 #2A9D8F;
            text-align: center;
            min-width: 80px;
        }

        .btn-icon {
            background: var(--c-yellow);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 #D4AC0D;
            transition: transform 0.1s;
            color: #555;
        }
        .btn-icon:active { transform: translateY(2px); box-shadow: 0 2px 0 #D4AC0D; }

        /* --- Screens --- */
        #start-screen, #finished-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .title-main { 
            font-size: 3rem; 
            font-weight: 900; 
            color: white; 
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2); 
            margin-bottom: 10px; 
        }
        .subtitle { 
            font-size: 1.2rem; 
            color: white; 
            font-weight: 600; 
            margin-bottom: 30px; 
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .btn-primary {
            background: white;
            color: var(--c-blue);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
            display: flex; align-items: center; gap: 10px;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }

        /* --- Playing Area --- */
        #playing-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .equation-bar {
            background: white;
            border-radius: 20px;
            padding: 10px;
            margin: 0 10px 10px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
        }
        .eq-text { font-size: 1.5rem; font-weight: 900; color: var(--c-dark); }
        .eq-result { color: var(--c-orange); }

        /* --- Board --- */
        .board-scroll {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .board-scroll::-webkit-scrollbar { display: none; }

        .board-content {
            display: flex;
            gap: 10px;
            margin: 0 auto;
        }

        .number-slot {
            background: rgba(255,255,255,0.9);
            border-radius: 20px;
            border: 4px solid white;
            padding: 10px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        /* Active highlight for building phase */
        .number-slot.active { border-color: #A5B4FC; box-shadow: 0 0 15px rgba(165, 180, 252, 0.5); }

        .slot-header { text-align: center; font-size: 1.8rem; font-weight: 900; color: #555; border-bottom: 2px solid #f0f0f0; margin-bottom: 5px; }

        .col-tens {
            background: #E0F7FA;
            border-radius: 12px;
            min-height: 60px;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; color: var(--block-ten); opacity: 0.8; }

        .col-ones {
            background: #FFF3E0;
            border-radius: 12px;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .label.ones { color: var(--block-one); }

        /* Ten Frame Grid */
        .ten-frame {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 3px;
            padding: 3px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
        }
        .frame-cell { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; position: relative; }
        .ghost-dot { width: 6px; height: 6px; background: rgba(0,0,0,0.1); border-radius: 50%; }

        /* Blocks - Using Oodles Style */
        .ten-rod {
            display: flex;
            gap: 1px;
            cursor: grab;
            transition: transform 0.1s;
        }
        .ten-rod:active { transform: scale(0.95); cursor: grabbing; }
        
        .rod-unit {
            width: 16px; height: 16px;
            background: var(--block-ten);
            border: 1px solid #3ABCB3;
            border-radius: 2px;
        }

        .one-cube {
            width: 22px; height: 22px;
            background: var(--block-one);
            border: 2px solid #E69500;
            border-radius: 4px;
            cursor: grab;
            box-shadow: 1px 1px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .one-cube:active { transform: scale(0.9); cursor: grabbing; }

        .operator { font-size: 2rem; color: white; font-weight: 900; align-self: center; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); }

        /* --- Controls Area --- */
        .controls-area {
            background: white;
            border-radius: 30px 30px 0 0;
            padding: 15px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 30;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .phase-badge { 
            background: #f1f2f6; color: #7f8c8d; font-size: 0.8rem; font-weight: 800; 
            padding: 5px 15px; border-radius: 20px; display: flex; gap: 5px; align-items: center; 
        }
        .btn-done { 
            background: var(--c-green); color: white; border: none; 
            padding: 8px 20px; border-radius: 20px; font-weight: 800; font-size: 0.9rem; 
            cursor: pointer; box-shadow: 0 4px 0 #76cba6; transition: transform 0.1s;
        }
        .btn-done:active { transform: translateY(3px); box-shadow: 0 1px 0 #76cba6; }

        .bank-container { display: flex; justify-content: center; gap: 20px; padding-bottom: 5px; }
        .bank-item {
            background: #f1f2f6; border: 2px solid #dfe4ea; border-radius: 16px; padding: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            cursor: grab; transition: transform 0.1s; min-width: 90px;
            box-shadow: 0 4px 0 #ced6e0;
        }
        .bank-item:active { transform: translateY(3px); box-shadow: 0 1px 0 #ced6e0; cursor: grabbing; }
        .bank-label { font-size: 0.7rem; font-weight: 800; color: #95a5a6; text-transform: uppercase; }

        /* Input Area (Answer Phase) */
        .answer-area { display: flex; justify-content: center; align-items: center; gap: 15px; padding: 10px; }
        .answer-input { 
            width: 100px; height: 60px; text-align: center; font-size: 2rem; font-weight: 900; color: var(--c-blue);
            border: 4px solid #f1f2f6; border-radius: 16px; outline: none; background: white;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .answer-input:focus { border-color: var(--c-blue); }
        .btn-check { 
            width: 60px; height: 60px; border-radius: 16px; 
            background: var(--c-blue); color: white; border: none; 
            font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 5px 0 #2A9D8F; transition: transform 0.1s;
        }
        .btn-check:active { transform: translateY(4px); box-shadow: 0 1px 0 #2A9D8F; }

        /* --- Drag Proxy --- */
        #drag-proxy { position: fixed; pointer-events: none; z-index: 100; transform: translate(-50%, -50%) rotate(-5deg); display: none; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- Mini Game Overlay --- */
        #minigame-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .bonus-title { font-size: 4rem; font-weight: 900; color: var(--c-yellow); text-shadow: 3px 3px 0 rgba(0,0,0,0.2); margin-bottom: 10px; animation: bounce 1s infinite; }
        .bonus-timer { color: white; font-size: 1.5rem; font-weight: 700; text-shadow: 1px 1px 0 rgba(0,0,0,0.3); }
        .balloon { position: absolute; width: 60px; height: 70px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1); border: 2px solid rgba(255,255,255,0.2); }
        .balloon::after { content: ''; position: absolute; top: 10px; left: 10px; width: 10px; height: 15px; background: rgba(255,255,255,0.4); border-radius: 50%; transform: rotate(45deg); }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Notifications */
        #notification {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            background: var(--c-yellow); color: #555; padding: 8px 20px; border-radius: 20px;
            font-size: 0.9rem; font-weight: 800; border: 2px solid white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1); pointer-events: none; opacity: 0; transition: opacity 0.3s;
            z-index: 40; display: flex; align-items: center; gap: 5px;
        }
    </style>
</head>
<body>
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div id="app">
        <!-- Header -->
        <header>
            <div class="title-group">
                <h1>Make Tens</h1>
            </div>
            <div class="controls">
                <button class="btn-icon" onclick="startGame()" title="Reset">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                </button>
                <div class="score-board">Score: <span id="score">0</span></div>
            </div>
        </header>

        <!-- Start Screen -->
        <div id="start-screen">
            <h1 class="title-main">Let's Add!</h1>
            <p class="subtitle">Drag, Drop & Regroup Strategy</p>
            <button class="btn-primary" onclick="startGame()">
                Start Game ‚ñ∂
            </button>
        </div>

        <!-- Playing Screen -->
        <div id="playing-screen" class="hidden">
            <!-- Notification Bubble -->
            <div id="notification">
                <span id="notif-text">Notification</span>
            </div>

            <!-- Equation -->
            <div class="equation-bar">
                <span id="eq-display" class="eq-text">28 + 9 + 15</span>
                <span class="eq-text">=</span>
                <span class="eq-result">?</span>
            </div>

            <!-- Main Board -->
            <div class="board-scroll">
                <div class="board-content" id="board-content">
                    <!-- Slots will be injected here -->
                </div>
            </div>

            <!-- Controls (Bottom) -->
            <div class="controls-area">
                <!-- Building Mode Controls -->
                <div id="controls-building">
                    <div class="phase-header">
                        <div class="phase-badge">
                            <svg class="icon" style="width:14px; height:14px;" viewBox="0 0 24 24"><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M16 18a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V12a5 5 0 0 1 10 0Z"/></svg>
                            Drag to build
                        </div>
                        <button class="btn-done" onclick="checkBuilding()">
                            Done <svg class="icon" style="width:14px;height:14px;display:inline;vertical-align:middle" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                        </button>
                    </div>
                    <div class="bank-container">
                        <div class="bank-item" onmousedown="startDrag(event, 'ten')" ontouchstart="startDrag(event, 'ten')">
                            <!-- Ten Rod Graphic (10 units) -->
                            <div class="ten-rod" style="pointer-events: none;">
                                <div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div>
                                <div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div><div class="rod-unit"></div>
                            </div>
                            <span class="bank-label" style="color: var(--block-ten);">Ten</span>
                        </div>
                        <div class="bank-item" onmousedown="startDrag(event, 'one')" ontouchstart="startDrag(event, 'one')">
                            <!-- One Cube Graphic -->
                            <div class="one-cube" style="pointer-events: none;"></div>
                            <span class="bank-label" style="color: var(--block-one);">One</span>
                        </div>
                    </div>
                </div>

                <!-- Answer Mode Controls -->
                <div id="controls-answering" class="hidden">
                    <div class="answer-area">
                        <span style="font-size: 1.2rem; font-weight: 700; color: #7f8c8d;">Sum = </span>
                        <input type="number" id="final-answer" class="answer-input" placeholder="?">
                        <button class="btn-check" onclick="checkAnswer()">
                            <svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Finished Screen -->
        <div id="finished-screen" class="hidden">
            <div style="background:white; padding:30px; border-radius:30px; box-shadow:0 20px 40px rgba(0,0,0,0.1); border: 5px solid var(--c-yellow);">
                <div style="font-size: 4rem; margin-bottom: 10px;">üèÜ</div>
                <h2 style="font-size: 2.5rem; font-weight: 900; color: var(--c-purple); margin-bottom: 5px;">Awesome!</h2>
                <p style="color: #64748b; font-weight: 700; margin-bottom: 20px;">Total Score: <span id="final-score">0</span></p>
                <button class="btn-primary" onclick="restartGame()">Play Again</button>
            </div>
        </div>

        <!-- Drag Proxy -->
        <div id="drag-proxy"></div>

        <!-- Mini Game Overlay -->
        <div id="minigame-overlay" class="hidden">
            <div class="bonus-title">BONUS!</div>
            <div class="bonus-timer">Pop bubbles! <span id="bonus-time">5</span>s</div>
            <!-- Balloons injected here -->
        </div>

    </div>

    <script>
        // --- State ---
        const MAX_QUESTIONS = 5;
        const STATE = {
            phase: 'start', // start, building, regrouping, answering, minigame, finished
            score: 0,
            questionIndex: 0,
            targets: [], // [num1, num2, num3]
            numbers: [], // [{tens, ones, isTransformed}, ...]
            dragItem: null // {type, x, y, sourceIdx}
        };

        // --- Audio ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function initAudio() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playTone(freq, type, duration, delay = 0, vol = 0.2) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime + delay);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(0, audioCtx.currentTime + delay);
            gain.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + delay + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + duration);
            osc.start(audioCtx.currentTime + delay);
            osc.stop(audioCtx.currentTime + delay + duration);
        }

        function playSound(name) {
            initAudio();
            if (name === 'pop') {
                playTone(600, 'sine', 0.15, 0, 0.3);
            } else if (name === 'drop') {
                playTone(300, 'triangle', 0.1, 0, 0.3);
            } else if (name === 'success') {
                [523, 659, 783, 1046].forEach((f, i) => playTone(f, 'sine', 0.3, i * 0.05, 0.2));
            } else if (name === 'wrong') {
                playTone(150, 'sawtooth', 0.3, 0, 0.3);
            } else if (name === 'bonus') {
                playTone(1200, 'sine', 0.1, 0, 0.2);
            } else if (name === 'start') {
                [440, 554, 659].forEach((f, i) => playTone(f, 'triangle', 0.4, i*0.1, 0.2));
            }
        }

        // --- Game Logic ---

        function generateQuestion() {
            // Generate 3 numbers logic from React code
            const ones1 = Math.floor(Math.random() * 3) + 7; 
            const tens1 = Math.floor(Math.random() * 2) + 1;
            const n1 = tens1 * 10 + ones1;

            const ones2 = Math.floor(Math.random() * 5) + 3;
            const tens2 = 0; 
            const n2 = tens2 * 10 + ones2;

            const ones3 = Math.floor(Math.random() * 9) + 1;
            const tens3 = Math.floor(Math.random() * 2) + 1;
            const n3 = tens3 * 10 + ones3;

            STATE.targets = [n1, n2, n3];
            // Reset built numbers
            STATE.numbers = [
                { tens: 0, ones: 0, isTransformed: false },
                { tens: 0, ones: 0, isTransformed: false },
                { tens: 0, ones: 0, isTransformed: false }
            ];
        }

        function startGame() {
            playSound('start');
            STATE.score = 0;
            STATE.questionIndex = 0;
            STATE.phase = 'building';
            generateQuestion();
            updateUI();
        }

        function restartGame() {
            document.getElementById('finished-screen').classList.add('hidden');
            startGame();
        }

        function checkBuilding() {
            let correct = true;
            for (let i = 0; i < 3; i++) {
                const tTens = Math.floor(STATE.targets[i] / 10);
                const tOnes = STATE.targets[i] % 10;
                if (STATE.numbers[i].tens !== tTens || STATE.numbers[i].ones !== tOnes) {
                    correct = false;
                    break;
                }
            }

            if (correct) {
                playSound('success');
                showNotification("Great! Now Make Tens", true);
                setTimeout(() => {
                    STATE.phase = 'regrouping'; // Regrouping actually allows answering in the UI logic
                    updateUI();
                }, 1000);
            } else {
                playSound('wrong');
                showNotification("Incorrect amount!", false);
            }
        }

        function checkAnswer() {
            const input = document.getElementById('final-answer');
            const userAns = parseInt(input.value);
            const total = STATE.targets.reduce((a, b) => a + b, 0);

            if (userAns === total) {
                playSound('success');
                STATE.score += 10;
                startMiniGame();
            } else {
                playSound('wrong');
                input.style.borderColor = '#FF6B6B';
                setTimeout(() => input.style.borderColor = '#f1f2f6', 1000);
            }
        }

        // --- Core Render & Update ---

        function updateUI() {
            // Screen Visibility
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('playing-screen').classList.add('hidden');
            document.getElementById('finished-screen').classList.add('hidden');

            if (STATE.phase === 'start') {
                document.getElementById('start-screen').classList.remove('hidden');
            } else if (STATE.phase === 'finished') {
                document.getElementById('finished-screen').classList.remove('hidden');
                document.getElementById('final-score').innerText = STATE.score;
            } else {
                document.getElementById('playing-screen').classList.remove('hidden');
            }

            // Header Info
            document.getElementById('score').innerText = STATE.score;
            // document.getElementById('question-count').innerText = `Q ${STATE.questionIndex + 1}/${MAX_QUESTIONS}`;

            // Equation
            if (STATE.phase === 'building') {
                document.getElementById('eq-display').innerText = STATE.targets.join(' + ');
            } else {
                // Show current built numbers in regrouping phase
                const vals = STATE.numbers.map(n => n.tens * 10 + n.ones);
                document.getElementById('eq-display').innerText = vals.join(' + ');
            }

            // Controls Visibility
            const buildControls = document.getElementById('controls-building');
            const answerControls = document.getElementById('controls-answering');
            
            if (STATE.phase === 'building') {
                buildControls.classList.remove('hidden');
                answerControls.classList.add('hidden');
            } else {
                buildControls.classList.add('hidden');
                answerControls.classList.remove('hidden');
                document.getElementById('final-answer').value = '';
            }

            // Render Board
            renderBoard();
        }

        function renderBoard() {
            const container = document.getElementById('board-content');
            container.innerHTML = '';

            STATE.targets.forEach((target, idx) => {
                const numData = STATE.numbers[idx];
                const displayNum = STATE.phase === 'building' ? target : (numData.tens * 10 + numData.ones);
                
                const slot = document.createElement('div');
                slot.className = `number-slot ${STATE.phase === 'building' ? 'active' : ''}`;
                slot.id = `slot-${idx}`; // For drop targeting

                // Header
                const header = document.createElement('div');
                header.className = 'slot-header';
                header.innerText = displayNum;
                slot.appendChild(header);

                // Tens Column
                const tensCol = document.createElement('div');
                tensCol.className = 'col-tens';
                const tenLabel = document.createElement('div');
                tenLabel.className = 'label';
                tenLabel.innerText = 'Tens';
                tensCol.appendChild(tenLabel);

                // Render Ten Rods
                for(let t=0; t<numData.tens; t++) {
                    const rod = document.createElement('div');
                    rod.className = 'ten-rod';
                    if (STATE.phase === 'building') {
                        rod.onclick = () => removeBlock(idx, 'ten');
                    }
                    if (numData.isTransformed && t === numData.tens - 1) {
                        rod.classList.add('animate-pop');
                    }
                    // Rod visual
                    for(let k=0; k<10; k++) {
                        const u = document.createElement('div'); u.className = 'rod-unit'; rod.appendChild(u);
                    }
                    tensCol.appendChild(rod);
                }
                slot.appendChild(tensCol);

                // Ones Column
                const onesCol = document.createElement('div');
                onesCol.className = 'col-ones';
                const oneLabel = document.createElement('div');
                oneLabel.className = 'label ones';
                oneLabel.innerText = 'Ones';
                onesCol.appendChild(oneLabel);

                // Render Ten Frame Grid
                const frame = document.createElement('div');
                frame.className = 'ten-frame';
                
                for(let i=0; i<10; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'frame-cell';
                    if (i < numData.ones) {
                        const cube = document.createElement('div');
                        cube.className = 'one-cube';
                        // Logic for removing or dragging regroup
                        if (STATE.phase === 'building') {
                            cube.onclick = () => removeBlock(idx, 'one');
                        } else if (STATE.phase === 'regrouping') {
                            // Enable dragging for regrouping
                            cube.onmousedown = (e) => startDrag(e, 'regroup-one', idx);
                            cube.ontouchstart = (e) => startDrag(e, 'regroup-one', idx);
                        }
                        cell.appendChild(cube);
                    } else {
                        const ghost = document.createElement('div');
                        ghost.className = 'ghost-dot';
                        cell.appendChild(ghost);
                    }
                    frame.appendChild(cell);
                }
                onesCol.appendChild(frame);
                slot.appendChild(onesCol);

                container.appendChild(slot);

                // Plus sign
                if (idx < 2) {
                    const plus = document.createElement('div');
                    plus.className = 'operator';
                    plus.innerText = '+';
                    container.appendChild(plus);
                }
            });
        }

        // --- Interaction Logic ---

        function removeBlock(idx, type) {
            if (type === 'ten' && STATE.numbers[idx].tens > 0) {
                STATE.numbers[idx].tens--;
                playSound('pop');
            } else if (type === 'one' && STATE.numbers[idx].ones > 0) {
                STATE.numbers[idx].ones--;
                playSound('pop');
            }
            renderBoard();
        }

        function startDrag(e, type, sourceIdx = null) {
            e.preventDefault();
            initAudio();
            const touch = e.touches ? e.touches[0] : e;
            
            STATE.dragItem = { type, x: touch.clientX, y: touch.clientY, sourceIdx };
            
            // Setup Proxy
            const proxy = document.getElementById('drag-proxy');
            proxy.style.display = 'block';
            proxy.style.left = touch.clientX + 'px';
            proxy.style.top = touch.clientY + 'px';
            proxy.innerHTML = ''; // Clear previous

            // Visual for proxy
            if (type === 'ten') {
                const r = document.createElement('div'); r.className = 'ten-rod';
                for(let k=0; k<10; k++){const u=document.createElement('div'); u.className='rod-unit'; r.appendChild(u);}
                proxy.appendChild(r);
            } else {
                const c = document.createElement('div'); c.className = 'one-cube';
                proxy.appendChild(c);
                if (type === 'regroup-one') playSound('pop');
            }

            document.addEventListener('mousemove', onDragMove);
            document.addEventListener('touchmove', onDragMove, {passive: false});
            document.addEventListener('mouseup', onDragEnd);
            document.addEventListener('touchend', onDragEnd);
        }

        function onDragMove(e) {
            if (!STATE.dragItem) return;
            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const proxy = document.getElementById('drag-proxy');
            proxy.style.left = touch.clientX + 'px';
            proxy.style.top = touch.clientY + 'px';
        }

        function onDragEnd(e) {
            if (!STATE.dragItem) return;
            
            const touch = e.changedTouches ? e.changedTouches[0] : e;
            const x = touch.clientX;
            const y = touch.clientY;
            const type = STATE.dragItem.type;
            const sourceIdx = STATE.dragItem.sourceIdx;

            // Hit Test
            const slots = document.querySelectorAll('.number-slot');
            let dropped = false;

            slots.forEach((slot, idx) => {
                const rect = slot.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    
                    if (type === 'ten' || type === 'one') {
                        if (STATE.phase === 'building') {
                            addBlock(idx, type);
                            dropped = true;
                        }
                    } else if (type === 'regroup-one') {
                        if (STATE.phase === 'regrouping' && idx !== sourceIdx) {
                            executeRegroup(sourceIdx, idx);
                            dropped = true;
                        }
                    }
                }
            });

            // Cleanup
            document.getElementById('drag-proxy').style.display = 'none';
            STATE.dragItem = null;
            document.removeEventListener('mousemove', onDragMove);
            document.removeEventListener('touchmove', onDragMove);
            document.removeEventListener('mouseup', onDragEnd);
            document.removeEventListener('touchend', onDragEnd);
        }

        function addBlock(idx, type) {
            const num = STATE.numbers[idx];
            if (type === 'ten') {
                if (num.tens < 9) {
                    num.tens++;
                    playSound('drop');
                } else {
                    showNotification("Column full!", false);
                }
            } else {
                if (num.ones < 10) {
                    num.ones++;
                    playSound('drop');
                }
            }
            renderBoard();
        }

        function executeRegroup(fromIdx, toIdx) {
            const target = STATE.numbers[toIdx];
            if (target.ones >= 10) {
                showNotification("Slot full!", false);
                return;
            }

            // Move one
            STATE.numbers[fromIdx].ones--;
            
            // Logic for making a ten
            let justTransformed = false;
            if (target.ones + 1 === 10) {
                target.ones = 0;
                target.tens++;
                target.isTransformed = true;
                playSound('success');
                showNotification("Ten Made!", true);
                setTimeout(() => {
                    STATE.numbers[toIdx].isTransformed = false;
                    renderBoard(); // Re-render to remove pop class
                }, 1000);
            } else {
                target.ones++;
                playSound('drop');
            }

            updateUI(); // Updates equation too
        }

        function showNotification(msg, isPositive) {
            const el = document.getElementById('notification');
            const txt = document.getElementById('notif-text');
            txt.innerText = msg;
            el.style.opacity = '1';
            el.style.top = '90px';
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.top = '80px';
            }, 1500);
        }

        // --- Mini Game ---
        let miniGameInterval;
        
        function startMiniGame() {
            STATE.phase = 'minigame';
            const overlay = document.getElementById('minigame-overlay');
            overlay.classList.remove('hidden');
            
            // Spawn Balloons
            const colors = ['#FF6B6B', '#4ECDC4', '#95E1D3', '#FFE66D', '#C39BD3'];
            
            for(let i=0; i<15; i++) {
                const b = document.createElement('div');
                b.className = 'balloon';
                b.style.background = colors[Math.floor(Math.random()*colors.length)];
                b.style.left = Math.random() * 90 + '%';
                b.style.top = (100 + Math.random() * 50) + '%';
                
                // Physics state stored on element
                b.dataset.speed = 0.5 + Math.random();
                b.dataset.y = parseFloat(b.style.top);
                
                b.onclick = function() {
                    this.remove();
                    playSound('bonus');
                    STATE.score += 5;
                    document.getElementById('score').innerText = STATE.score;
                };
                
                overlay.appendChild(b);
            }

            let timeLeft = 5;
            const timeDisplay = document.getElementById('bonus-time');
            
            const timer = setInterval(() => {
                timeLeft--;
                timeDisplay.innerText = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(timer);
                    endMiniGame();
                }
            }, 1000);

            // Animation Loop
            function loop() {
                if (STATE.phase !== 'minigame') return;
                const balloons = document.querySelectorAll('.balloon');
                balloons.forEach(b => {
                    let y = parseFloat(b.dataset.y);
                    y -= parseFloat(b.dataset.speed);
                    b.dataset.y = y;
                    b.style.top = y + '%';
                });
                requestAnimationFrame(loop);
            }
            loop();
        }

        function endMiniGame() {
            STATE.phase = 'regrouping'; // reset temp
            document.getElementById('minigame-overlay').classList.add('hidden');
            document.getElementById('minigame-overlay').innerHTML = `
                <div class="bonus-title">BONUS!</div>
                <div class="bonus-timer">Pop bubbles! <span id="bonus-time">5</span>s</div>
            `; // Clear balloons
            
            if (STATE.questionIndex + 1 >= MAX_QUESTIONS) {
                STATE.phase = 'finished';
                updateUI();
            } else {
                STATE.questionIndex++;
                STATE.phase = 'building';
                generateQuestion();
                updateUI();
            }
        }

    </script>
</body>
</html>
