<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tens & Ones Addition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-sky: #87CEEB;
            --font-main: 'Poppins', sans-serif;
            
            /* Vibrant Colors */
            --c-red: #FF6B6B;
            --c-blue: #4ECDC4;
            --c-green: #95E1D3;
            --c-yellow: #FFE66D;
            --c-orange: #FFA500;
            --c-purple: #C39BD3;
            --c-white: #FFFFFF;
            --c-dark: #2c3e50;
            
            /* Base-10 Block Colors */
            --block-ten: #4ECDC4; /* Teal for Tens */
            --block-one: #FFA500; /* Orange for Ones */
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-sky);
            background-image: 
                radial-gradient(circle at 50% 50%, white 10px, transparent 11px),
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.6) 20px, transparent 21px),
                radial-gradient(circle at 90% 80%, rgba(255,255,255,0.6) 30px, transparent 31px);
            background-size: 100px 100px, 200px 200px, 300px 300px;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            color: var(--c-dark);
        }

        /* --- Header --- */
        header {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.1);
            margin-bottom: 20px;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid white;
            z-index: 20;
        }

        .title-group h1 {
            color: var(--c-dark);
            font-size: 1.2rem;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 800;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-board {
            background: var(--c-blue);
            color: white;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 800;
            box-shadow: 0 4px 0 #2A9D8F;
            text-align: center;
            min-width: 100px;
        }

        .btn-icon {
            background: var(--c-yellow);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 #D4AC0D;
            transition: transform 0.1s;
        }
        .btn-icon:active { transform: translateY(2px); box-shadow: 0 2px 0 #D4AC0D; }

        /* --- Screens --- */
        #app {
            width: 100%;
            max-width: 600px;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .hidden { display: none !important; }

        /* Start Screen */
        #start-screen, #finished-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s;
        }

        .title-main { 
            font-size: 3rem; 
            font-weight: 900; 
            color: white; 
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2); 
            margin-bottom: 10px; 
        }
        .subtitle { 
            font-size: 1.2rem; 
            color: white; 
            font-weight: 600; 
            margin-bottom: 30px; 
            background: rgba(0,0,0,0.2);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .btn-primary {
            background: white;
            color: var(--c-blue);
            border: none;
            padding: 15px 40px;
            font-size: 1.5rem;
            border-radius: 50px;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }

        /* --- Game Board Area --- */
        #playing-screen {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        /* Equation Display */
        .equation-bar {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
        }

        .eq-nums {
            font-size: 2rem;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .n1 { color: var(--c-blue); }
        .n2 { color: var(--c-orange); }
        .ans-mark { color: #ccc; }

        /* Notification */
        .notification-area {
            height: 30px;
            display: flex;
            justify-content: center;
            margin-bottom: 5px;
        }
        .notif-bubble {
            background: var(--c-yellow);
            color: #665;
            padding: 4px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: 800;
            animation: bounce 0.5s;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1);
        }

        /* The Board */
        .board-container {
            flex: 1;
            background: rgba(255,255,255,0.9);
            border-radius: 25px 25px 0 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            border: 4px solid white;
        }

        .board-headers {
            display: flex;
            margin-bottom: 5px;
        }
        .col-header {
            flex: 1;
            text-align: center;
            padding: 5px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 1rem;
            border-radius: 10px;
            margin: 0 5px;
        }
        .header-tens { background: #E0F7FA; color: var(--block-ten); }
        .header-ones { background: #FFF3E0; color: var(--block-one); }

        .board-cols {
            flex: 1;
            display: flex;
            position: relative;
        }

        .col {
            flex: 1;
            padding: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            border-radius: 15px;
            margin: 0 5px;
            background: rgba(0,0,0,0.03);
            min-height: 200px;
        }

        .col-section {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            min-height: 40px;
            padding: 5px 0;
        }
        
        .divider {
            width: 80%;
            border-bottom: 2px dashed #ccc;
            margin: 10px 0;
            position: relative;
        }
        .divider-label {
            position: absolute;
            right: 0;
            top: -10px;
            font-size: 0.7rem;
            background: #eee;
            padding: 0 5px;
            border-radius: 5px;
            color: #888;
            font-weight: 700;
        }

        /* Rods & Cubes */
        .ten-rod {
            display: flex;
            gap: 1px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .ten-rod:active { transform: scale(0.95); }
        .ten-block {
            width: 18px; height: 18px;
            background: var(--block-ten);
            border: 2px solid #3ABCB3;
            border-radius: 2px;
        }
        .ten-rod.ghost .ten-block { background: #B2EBF2; border-color: #80DEEA; opacity: 0.6; }

        .one-cube {
            width: 22px; height: 22px;
            background: var(--block-one);
            border: 2px solid #E69500;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }
        .one-cube:active { transform: scale(0.95); }
        .one-cube.ghost { background: #FFE0B2; border-color: #FFCC80; opacity: 0.6; }

        /* Controls */
        .controls-bank {
            background: white;
            padding: 10px 10px 20px 10px; /* Extra padding bottom for mobile safetey */
            display: flex;
            gap: 15px;
        }
        .ctrl-btn {
            flex: 1;
            background: #f1f2f6;
            border: 2px solid #dfe4ea;
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 #ced6e0;
        }
        .ctrl-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #ced6e0; }
        .ctrl-btn:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: none; transform: translateY(3px); }
        .ctrl-label { color: #7f8c8d; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; }

        /* Specific style to fit 10 blocks inside the button */
        .ctrl-btn .ten-block {
            width: 12px;
            height: 12px;
            border-width: 1px;
        }
        .ctrl-btn .ten-rod {
            gap: 1px;
        }

        /* Options Grid */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
            padding: 0 10px 20px 10px;
        }
        .opt-btn {
            height: 55px;
            background: white;
            border: none;
            border-radius: 15px;
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--c-dark);
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            transition: all 0.1s;
        }
        .opt-btn:hover { transform: translateY(-2px); }
        .opt-btn:active { transform: translateY(2px); box-shadow: 0 0 0 rgba(0,0,0,0.1); }
        
        .opt-btn.correct { background: var(--c-green); color: white; box-shadow: 0 4px 0 #76cba6; }
        .opt-btn.wrong { background: var(--c-red); color: white; box-shadow: 0 4px 0 #d65a5a; }
        .opt-btn:disabled { opacity: 0.8; cursor: not-allowed; }

        /* Regroup Overlay */
        #regroup-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(2px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 15px;
        }
        .regroup-box {
            background: #fff;
            border: 3px solid var(--c-green);
            border-radius: 15px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            animation: pulse 1s infinite;
        }
        .regroup-bundle {
            background: #FFF3E0;
            padding: 5px;
            border-radius: 8px;
            border: 2px solid var(--block-one);
            display: flex;
            flex-wrap: wrap;
            width: 100px;
            gap: 2px;
            justify-content: center;
            cursor: grab;
            position: relative;
        }
        .regroup-bundle:active { cursor: grabbing; }
        .arrow-badge {
            position: absolute;
            top: -10px; right: -10px;
            background: var(--c-green);
            color: white;
            border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        /* Drag Ghost */
        #drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            display: none;
            transform: translate(-50%, -50%) rotate(-5deg);
        }
        .ghost-rod {
            background: var(--block-one);
            padding: 5px;
            border-radius: 5px;
            border: 2px solid white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 1px;
        }

        /* Modal (Finished) */
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: bounceIn 0.6s;
            border: 5px solid var(--c-yellow);
        }

        /* Bonus Overlay (Balloons) */
        #bonus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 50;
            display: none;
            overflow: hidden;
        }
        .balloon {
            position: absolute;
            width: 70px; height: 85px;
            background: var(--c-red);
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.1);
        }
        .balloon::before { content: ''; width: 2px; height: 40px; background: rgba(255,255,255,0.8); position: absolute; bottom: -35px; }
        .balloon::after { content: ''; width: 15px; height: 25px; background: rgba(255,255,255,0.3); border-radius: 50%; position: absolute; top: 15px; left: 15px; transform: rotate(20deg); }
        
        /* Balloon Colors */
        .b-red { background: var(--c-red); }
        .b-blue { background: var(--c-blue); }
        .b-green { background: var(--c-green); }
        .b-yellow { background: var(--c-yellow); }
        .b-purple { background: var(--c-purple); }
        .b-orange { background: var(--c-orange); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes bounceIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0); } 70% { transform: scale(1.2); } 100% { transform: scale(1); } }

    </style>
</head>
<body>
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <header>
        <div class="title-group">
            <h1>Tens & Ones</h1>
        </div>
        <div class="controls">
             <button class="btn-icon" onclick="resetGame()" title="Restart">ðŸ”„</button>
             <button class="btn-icon" onclick="speakEquation()" title="Listen">ðŸ”Š</button>
        </div>
        <div class="score-board">Score: <span id="score-display">0</span></div>
    </header>

    <div id="app">
        
        <!-- START SCREEN -->
        <div id="start-screen">
            <h1 class="title-main">Let's Add!</h1>
            <p class="subtitle">Use Blocks & Regrouping</p>
            <button class="btn-primary" onclick="startGame()">Start Game â–¶</button>
        </div>

        <!-- PLAYING SCREEN -->
        <div id="playing-screen" class="hidden">
            <!-- Equation -->
            <div class="equation-bar">
                <div class="eq-nums">
                    <span class="n1" id="eq-n1">0</span>
                    <span class="ans-mark">+</span>
                    <span class="n2" id="eq-n2">0</span>
                    <span class="ans-mark">=</span>
                    <span class="ans-mark">?</span>
                </div>
            </div>

            <!-- Notification -->
            <div class="notification-area">
                <div id="notification-bubble" class="notif-bubble hidden">You have enough ones!</div>
            </div>

            <!-- Board -->
            <div class="board-container">
                <div class="board-headers">
                    <div class="col-header header-tens">Tens</div>
                    <div class="col-header header-ones">Ones</div>
                </div>
                <div class="board-cols">
                    <!-- Tens Column -->
                    <div class="col col-tens" id="tens-col"></div>
                    <!-- Ones Column -->
                    <div class="col col-ones" id="ones-col">
                        <!-- Regroup Overlay -->
                        <div id="regroup-overlay">
                            <div class="regroup-box">
                                <span style="font-size: 12px; color: var(--c-green); font-weight: 800; margin-bottom: 5px;">Too many ones!</span>
                                <div class="regroup-bundle" id="regroup-bundle">
                                    <div class="arrow-badge">âžœ</div>
                                    <!-- 10 dots generated by JS -->
                                </div>
                                <span style="font-size: 11px; color: #888; font-weight: 700; margin-top: 5px;">Drag to Tens</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Controls Bank -->
            <div class="controls-bank">
                <button class="ctrl-btn" onclick="addTen()">
                    <!-- Updated to have 10 blocks (Ten Rod) -->
                    <div class="ten-rod">
                        <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                        <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                        <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                        <div class="ten-block"></div>
                    </div>
                    <span class="ctrl-label">Add Ten</span>
                </button>
                <button class="ctrl-btn" id="btn-add-one" onclick="addOne()">
                    <div class="one-cube"></div>
                    <span class="ctrl-label">Add One</span>
                </button>
            </div>

            <!-- Options -->
            <div class="options-grid" id="options-grid"></div>
        </div>

        <!-- FINISHED SCREEN -->
        <div id="finished-screen" class="hidden">
            <div class="modal-content">
                <div style="font-size: 4rem; margin-bottom: 10px;">ðŸŒŸ</div>
                <h1 style="color: var(--c-purple); font-size: 2.5rem; font-weight: 900; margin: 0;">You're a Star!</h1>
                <p style="color: #666; font-size: 1.2rem; font-weight: 600; margin: 10px 0 20px 0;">Total Score: <span id="final-score">0</span></p>
                <button class="btn-primary" onclick="resetGame()">Play Again</button>
            </div>
        </div>

        <!-- DRAG GHOST -->
        <div id="drag-ghost">
            <div class="ghost-rod">
                <div style="display: flex; gap: 1px;">
                    <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                </div>
                <div style="display: flex; gap: 1px; margin-top: 1px;">
                    <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                </div>
            </div>
        </div>

        <!-- BONUS OVERLAY -->
        <div id="bonus-overlay">
            <div style="position: absolute; top: 15%; width: 100%; text-align: center; pointer-events: none;">
                <h2 style="font-size: 3.5rem; color: var(--c-yellow); font-weight: 900; text-shadow: 2px 2px 0 rgba(0,0,0,0.2); margin: 0; animation: pulse 1s infinite;">BONUS!</h2>
                <p style="color: white; font-weight: 700; font-size: 1.2rem; text-shadow: 1px 1px 0 rgba(0,0,0,0.3);">Pop the balloons!</p>
            </div>
            <div id="balloon-container"></div>
        </div>

    </div>

    <script>
        // --- STATE ---
        const MAX_QUESTIONS = 10;
        let state = {
            phase: 'start', 
            score: 0,
            questionIndex: 0,
            question: { n1: 0, n2: 0, ans: 0 },
            options: [],
            n1Entered: { tens: 0, ones: 0 },
            n2Entered: { tens: 0, ones: 0 },
            carriedTens: 0,
            isRegrouping: false,
            feedback: null,
            selectedOption: null,
            bonusActive: false
        };

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const ctx = audioCtx;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'pop') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.exponentialRampToValueAtTime(800, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'bonusPop') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.15);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'magic') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.4);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.3, now + 0.2);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                osc.start(now); osc.stop(now + 0.4);
            } else if (type === 'success') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine'; o.frequency.value = freq;
                    g.gain.setValueAtTime(0.15, now + i*0.1);
                    g.gain.exponentialRampToValueAtTime(0.01, now + i*0.1 + 0.2);
                    o.start(now + i*0.1); o.stop(now + i*0.1 + 0.2);
                });
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'fanfare') {
                [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50].forEach((freq, i) => {
                    const o = ctx.createOscillator();
                    const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = i % 2 === 0 ? 'triangle' : 'square'; 
                    o.frequency.value = freq;
                    const t = now + i * 0.15;
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.linearRampToValueAtTime(0, t + 0.3);
                    o.start(t); o.stop(t + 0.4);
                });
            }
        }

        function speakEquation() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const text = `${state.question.n1} plus ${state.question.n2} equals?`;
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            }
        }

        // --- GAME LOGIC ---

        function generateQuestion() {
            const n1 = Math.floor(Math.random() * 30) + 1;
            const maxN2 = 50 - n1;
            const n2 = Math.floor(Math.random() * (maxN2 + 1));
            const ans = n1 + n2;

            const wrongOptions = new Set();
            while (wrongOptions.size < 3) {
                const offset = Math.floor(Math.random() * 10) - 5;
                const wrong = ans + offset;
                if (wrong >= 0 && wrong <= 60 && wrong !== ans) wrongOptions.add(wrong);
            }
            const allOptions = [ans, ...Array.from(wrongOptions)].sort(() => Math.random() - 0.5);

            state.question = { n1, n2, ans };
            state.options = allOptions;
            state.n1Entered = { tens: 0, ones: 0 };
            state.n2Entered = { tens: 0, ones: 0 };
            state.carriedTens = 0;
            state.feedback = null;
            state.selectedOption = null;
            state.isRegrouping = false;
        }

        function startGame() {
            playSound('success');
            state.score = 0;
            state.questionIndex = 0;
            state.phase = 'playing';
            generateQuestion();
            updateUI();
        }

        function resetGame() {
            state.phase = 'start';
            state.bonusActive = false;
            updateUI();
        }

        // --- INPUT HANDLERS ---

        function addOne() {
            // New logic: Check total value represented vs total needed
            const currentVisual = state.n1Entered.ones + state.n2Entered.ones;
            const carriedValue = state.carriedTens * 10;
            const currentTotal = currentVisual + carriedValue;
            
            const targetTotal = (state.question.n1 % 10) + (state.question.n2 % 10);

            if (currentTotal >= targetTotal) {
                showNotification("You have enough Ones!");
                playSound('wrong');
                return;
            }

            // Distribute to N1 then N2 based on individual capacity
            const n1Limit = state.question.n1 % 10;
            const n2Limit = state.question.n2 % 10;

            if (state.n1Entered.ones < n1Limit) {
                playSound('pop');
                state.n1Entered.ones++;
            } else if (state.n2Entered.ones < n2Limit) {
                playSound('pop');
                state.n2Entered.ones++;
            } else {
                // If specific slots are full but total still needs ones (due to regrouping logic quirks), 
                // we force add to N1 to allow completion.
                playSound('pop');
                state.n1Entered.ones++;
            }
            updateBoard();
        }

        function addTen() {
            const n1TargetTens = Math.floor(state.question.n1 / 10);
            const n2TargetTens = Math.floor(state.question.n2 / 10);

            if (state.n1Entered.tens < n1TargetTens) {
                playSound('pop');
                state.n1Entered.tens++;
            } else if (state.n2Entered.tens < n2TargetTens) {
                playSound('pop');
                state.n2Entered.tens++;
            } else {
                showNotification("You have enough Tens!");
                playSound('wrong');
            }
            updateBoard();
        }

        function removeOne(isN1) {
            // Logic updated: Allow removal even if carriedTens > 0
            if (isN1 && state.n1Entered.ones > 0) state.n1Entered.ones--;
            else if (!isN1 && state.n2Entered.ones > 0) state.n2Entered.ones--;
            updateBoard();
        }

        function removeTen(isN1) {
            if (isN1 && state.n1Entered.tens > 0) state.n1Entered.tens--;
            else if (!isN1 && state.n2Entered.tens > 0) state.n2Entered.tens--;
            updateBoard();
        }

        function performRegroup() {
            playSound('magic');
            state.carriedTens = 1;
            state.isRegrouping = false; 
            showNotification("Regrouped!");

            let remainingToRemove = 10;
            
            let newN2Ones = state.n2Entered.ones;
            if (newN2Ones >= remainingToRemove) {
                newN2Ones -= remainingToRemove;
                remainingToRemove = 0;
            } else {
                remainingToRemove -= newN2Ones;
                newN2Ones = 0;
            }

            let newN1Ones = state.n1Entered.ones;
            if (remainingToRemove > 0) {
                newN1Ones = Math.max(0, newN1Ones - remainingToRemove);
            }

            state.n2Entered.ones = newN2Ones;
            state.n1Entered.ones = newN1Ones;
            updateBoard();
        }

        function handleAnswer(val) {
            if (state.feedback) return;
            
            state.selectedOption = val;
            
            if (val === state.question.ans) {
                playSound('success');
                state.feedback = 'correct';
                state.score += 10;
                
                setTimeout(() => {
                    state.questionIndex++;
                    startBonusRound();
                }, 1000);
            } else {
                playSound('wrong');
                state.feedback = 'wrong';
                setTimeout(() => {
                    state.feedback = null;
                    state.selectedOption = null;
                    updateUI();
                }, 1500);
            }
            updateUI();
        }

        // --- UI UPDATERS ---

        function updateUI() {
            const startScreen = document.getElementById('start-screen');
            const playingScreen = document.getElementById('playing-screen');
            const finishedScreen = document.getElementById('finished-screen');

            startScreen.classList.add('hidden');
            playingScreen.classList.add('hidden');
            finishedScreen.classList.add('hidden');

            if (state.phase === 'start') {
                startScreen.classList.remove('hidden');
            } else if (state.phase === 'playing') {
                playingScreen.classList.remove('hidden');
                
                document.getElementById('score-display').innerText = state.score;
                document.getElementById('eq-n1').innerText = state.question.n1;
                document.getElementById('eq-n2').innerText = state.question.n2;

                updateBoard();
                renderOptions();

            } else if (state.phase === 'finished') {
                finishedScreen.classList.remove('hidden');
                document.getElementById('final-score').innerText = state.score;
            }
        }

        function updateBoard() {
            // Render Tens
            const tensCol = document.getElementById('tens-col');
            tensCol.innerHTML = '';
            
            const n1TensContainer = document.createElement('div');
            n1TensContainer.className = 'col-section';
            for(let i=0; i<state.n1Entered.tens; i++) {
                n1TensContainer.appendChild(createRod(() => removeTen(true)));
            }
            if(state.n1Entered.tens < Math.floor(state.question.n1/10)) {
                n1TensContainer.appendChild(createRod(null, true));
            }
            tensCol.appendChild(n1TensContainer);

            const divider = document.createElement('div');
            divider.className = 'divider';
            divider.innerHTML = '<span class="divider-label">Num 2</span>';
            tensCol.appendChild(divider);

            const n2TensContainer = document.createElement('div');
            n2TensContainer.className = 'col-section';
            for(let i=0; i<state.n2Entered.tens; i++) {
                n2TensContainer.appendChild(createRod(() => removeTen(false)));
            }
            const n1Full = state.n1Entered.tens === Math.floor(state.question.n1/10);
            if(n1Full && state.n2Entered.tens < Math.floor(state.question.n2/10)) {
                n2TensContainer.appendChild(createRod(null, true));
            }
            tensCol.appendChild(n2TensContainer);

            if (state.carriedTens > 0) {
                const carried = document.createElement('div');
                carried.style.marginTop = '10px';
                carried.style.animation = 'popIn 0.5s';
                carried.style.position = 'relative';
                carried.appendChild(createRod());
                const badge = document.createElement('div');
                badge.className = 'arrow-badge';
                badge.innerText = '+1';
                carried.appendChild(badge);
                tensCol.appendChild(carried);
            }

            // Render Ones
            const onesCol = document.getElementById('ones-col');
            const overlay = document.getElementById('regroup-overlay');
            Array.from(onesCol.children).forEach(child => {
                if (child.id !== 'regroup-overlay') onesCol.removeChild(child);
            });

            const n1OnesContainer = document.createElement('div');
            n1OnesContainer.className = 'col-section';
            for(let i=0; i<state.n1Entered.ones; i++) {
                n1OnesContainer.appendChild(createCube(() => removeOne(true)));
            }
            if(state.carriedTens === 0 && state.n1Entered.ones < (state.question.n1 % 10)) {
                n1OnesContainer.appendChild(createCube(null, true));
            }
            onesCol.insertBefore(n1OnesContainer, overlay);

            const div2 = document.createElement('div');
            div2.className = 'divider';
            onesCol.insertBefore(div2, overlay);

            const n2OnesContainer = document.createElement('div');
            n2OnesContainer.className = 'col-section';
            for(let i=0; i<state.n2Entered.ones; i++) {
                n2OnesContainer.appendChild(createCube(() => removeOne(false)));
            }
            if(state.carriedTens === 0 && n1Full && state.n2Entered.ones < (state.question.n2 % 10)) {
                n2OnesContainer.appendChild(createCube(null, true));
            }
            onesCol.insertBefore(n2OnesContainer, overlay);

            // Regroup Logic
            const totalOnes = state.n1Entered.ones + state.n2Entered.ones;
            const needsRegrouping = totalOnes >= 10;
            const isRegrouped = state.carriedTens > 0;
            
            if (needsRegrouping && !isRegrouped) {
                overlay.style.display = 'flex';
                const bundle = document.getElementById('regroup-bundle');
                bundle.innerHTML = '<div class="arrow-badge">âžœ</div>';
                for(let i=0; i<10; i++) {
                    const d = document.createElement('div');
                    d.style.width = '14px'; d.style.height = '14px';
                    d.style.background = 'var(--block-one)'; d.style.borderRadius = '2px';
                    d.style.border = '1px solid #E69500';
                    bundle.appendChild(d);
                }
            } else {
                overlay.style.display = 'none';
            }

            const btnAddOne = document.getElementById('btn-add-one');
            // Logic Update: Disable only if total value matches target value
            const currentTotalValue = state.n1Entered.ones + state.n2Entered.ones + (state.carriedTens * 10);
            const targetTotalValue = (state.question.n1 % 10) + (state.question.n2 % 10);
            btnAddOne.disabled = currentTotalValue >= targetTotalValue;

            const currentVal = (state.n1Entered.tens + state.n2Entered.tens + state.carriedTens) * 10 + state.n1Entered.ones + state.n2Entered.ones;
            const isValid = currentVal === state.question.ans && (!needsRegrouping || isRegrouped);
            
            const optBtns = document.querySelectorAll('.opt-btn');
            optBtns.forEach(btn => {
                btn.disabled = !isValid || state.feedback !== null;
            });
        }

        function createRod(onClick, isGhost) {
            const rod = document.createElement('div');
            rod.className = `ten-rod ${isGhost ? 'ghost' : ''}`;
            for(let i=0; i<10; i++) {
                const b = document.createElement('div');
                b.className = 'ten-block';
                rod.appendChild(b);
            }
            if(onClick) rod.onclick = onClick;
            return rod;
        }

        function createCube(onClick, isGhost) {
            const cube = document.createElement('div');
            cube.className = `one-cube ${isGhost ? 'ghost' : ''}`;
            if(onClick) cube.onclick = onClick;
            return cube;
        }

        function renderOptions() {
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            state.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = opt;
                if (state.selectedOption === opt) {
                    btn.classList.add(state.feedback);
                }
                btn.onclick = () => handleAnswer(opt);
                grid.appendChild(btn);
            });
        }

        function showNotification(msg) {
            const el = document.getElementById('notification-bubble');
            el.innerText = msg;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 1500);
        }

        // --- DRAG AND DROP (Regrouping) ---
        const bundle = document.getElementById('regroup-bundle');
        const ghost = document.getElementById('drag-ghost');
        const tensCol = document.getElementById('tens-col');
        let isDragging = false;

        function handleStart(e) {
            e.preventDefault();
            isDragging = true;
            ghost.style.display = 'block';
            moveGhost(e);
        }

        function handleMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            moveGhost(e);
        }

        function handleEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            ghost.style.display = 'none';

            const touch = e.changedTouches ? e.changedTouches[0] : e;
            const x = touch.clientX;
            const y = touch.clientY;
            
            const rect = tensCol.getBoundingClientRect();
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                performRegroup();
            }
        }

        function moveGhost(e) {
            const touch = e.touches ? e.touches[0] : e;
            ghost.style.left = touch.clientX + 'px';
            ghost.style.top = touch.clientY + 'px';
        }

        bundle.addEventListener('mousedown', handleStart);
        document.addEventListener('mousemove', handleMove);
        document.addEventListener('mouseup', handleEnd);
        
        bundle.addEventListener('touchstart', handleStart, { passive: false });
        document.addEventListener('touchmove', handleMove, { passive: false });
        document.addEventListener('touchend', handleEnd);

        // --- BONUS ROUND (Balloons) ---
        const bonusOverlay = document.getElementById('bonus-overlay');
        const balloonContainer = document.getElementById('balloon-container');
        let balloons = [];
        let animationFrame;

        function startBonusRound() {
            state.bonusActive = true;
            bonusOverlay.style.display = 'block';
            balloonContainer.innerHTML = '';
            balloons = [];
            
            const colors = ['b-red', 'b-blue', 'b-green', 'b-yellow', 'b-purple', 'b-orange'];
            
            for(let i=0; i<15; i++) {
                const b = document.createElement('div');
                const color = colors[Math.floor(Math.random() * colors.length)];
                b.className = `balloon ${color}`;
                
                const data = {
                    el: b,
                    x: Math.random() * 80 + 10,
                    y: 100 + Math.random() * 50,
                    speed: 0.2 + Math.random() * 0.3,
                    scale: 0.8 + Math.random() * 0.4
                };
                
                b.style.left = data.x + '%';
                b.style.transform = `scale(${data.scale})`;
                
                b.onmousedown = (e) => popBalloon(e, data, i);
                b.ontouchstart = (e) => popBalloon(e, data, i);
                
                balloonContainer.appendChild(b);
                balloons.push(data);
            }

            animateBalloons();

            setTimeout(() => {
                endBonusRound();
            }, 4500);
        }

        function popBalloon(e, data, index) {
            e.stopPropagation(); 
            e.preventDefault();
            if (!state.bonusActive || !data.el.parentNode) return;
            
            playSound('bonusPop');
            state.score += 5;
            document.getElementById('score-display').innerText = state.score;
            
            data.el.style.transform = `scale(1.5)`;
            data.el.style.opacity = '0';
            setTimeout(() => {
                if(data.el.parentNode) data.el.parentNode.removeChild(data.el);
            }, 100);
            
            balloons.splice(index, 1);
        }

        function animateBalloons() {
            if (!state.bonusActive) return;
            
            balloons.forEach(b => {
                b.y -= b.speed;
                b.el.style.top = b.y + '%';
            });
            
            animationFrame = requestAnimationFrame(animateBalloons);
        }

        function endBonusRound() {
            state.bonusActive = false;
            cancelAnimationFrame(animationFrame);
            bonusOverlay.style.display = 'none';
            
            if (state.questionIndex >= MAX_QUESTIONS) {
                state.phase = 'finished';
                playSound('fanfare');
                updateUI();
            } else {
                generateQuestion();
                updateUI();
            }
        }

    </script>
</body>
</html>
