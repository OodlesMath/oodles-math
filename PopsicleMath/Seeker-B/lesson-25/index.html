<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tens & Ones: Subtraction Fun</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&family=Cherry+Bomb+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-sky: #a29bfe;
            --font-main: 'Poppins', sans-serif;
            --font-title: 'Cherry Bomb One', cursive;
            --c-red: #ff7675;
            --c-blue: #0984e3;
            --c-green: #00b894;
            --c-yellow: #fdcb6e;
            --c-orange: #e17055;
            --c-purple: #6c5ce7;
            --c-white: #ffffff;
            --c-dark: #2d3436;
            --block-ten: #00cec9;
            --block-one: #fab1a0;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background: linear-gradient(135deg, #a29bfe 0%, #74b9ff 50%, #55efc4 100%);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--c-dark);
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        header {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 3px solid white;
            z-index: 20;
        }

        .title-group h1 {
            font-family: var(--font-title);
            color: var(--c-blue);
            font-size: 1.4rem;
            margin: 0;
            text-shadow: 1px 1px 0px white, 3px 3px 0px rgba(0,0,0,0.1);
            letter-spacing: 1px;
        }

        .controls {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        .score-board {
            background: var(--c-purple);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 800;
            box-shadow: 0 4px 0 #4834d4;
            min-width: 80px;
            text-align: center;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-icon {
            background: var(--c-yellow);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 4px 0 #cc8e35;
            transition: transform 0.1s;
        }
        .btn-icon:active { transform: translateY(2px); box-shadow: 0 2px 0 #cc8e35; }
        .btn-icon:disabled { opacity: 0.5; cursor: not-allowed; box-shadow: 0 4px 0 #cc8e35 !important; }

        #app {
            width: 100%;
            max-width: 600px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .hidden { display: none !important; }

        #start-screen, #setup-screen, #finished-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            margin: 10px;
            padding: 20px;
            border: 3px solid white;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .title-main { 
            font-family: var(--font-title);
            font-size: 2.5rem; 
            color: white; 
            text-shadow: 3px 3px 0 var(--c-blue), 6px 6px 0 rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .subtitle { 
            font-size: 1rem; 
            color: white; 
            font-weight: 600; 
            margin-bottom: 25px;
            background: rgba(0,0,0,0.15);
            padding: 6px 20px;
            border-radius: 20px;
        }

        .btn-primary {
            background: white;
            color: var(--c-blue);
            border: none;
            padding: 12px 35px;
            font-size: 1.2rem;
            border-radius: 40px;
            font-family: var(--font-title);
            cursor: pointer;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 400px;
            padding: 15px;
        }
        .level-btn {
            background: white;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 12px;
            font-family: var(--font-title);
            font-size: 1.4rem;
            color: var(--c-blue);
            cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
        }

        .equation-bar {
            background: white;
            border-radius: 20px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 rgba(0,0,0,0.05);
            border: 2px solid #f0f0f0;
        }

        .eq-nums {
            font-family: var(--font-title);
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .board-container {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 0 rgba(0,0,0,0.05);
            border: 4px solid white;
            min-height: 300px;
        }

        .board-headers {
            display: flex;
            margin-bottom: 10px;
            gap: 8px;
        }
        .col-header {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.8rem;
            border-radius: 10px;
        }
        .header-tens { background: #e0f7fa; color: var(--c-blue); }
        .header-ones { background: #fff3e0; color: var(--c-orange); }

        .board-cols {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .col {
            flex: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            border-radius: 15px;
            background: rgba(0,0,0,0.02);
            border: 2px dashed rgba(0,0,0,0.03);
            transition: background 0.2s;
        }
        .col.drag-over {
            background: rgba(0, 184, 148, 0.1);
            border-color: var(--c-green);
        }

        .col-section {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            padding: 5px 0;
            justify-items: center;
        }

        .ten-rod {
            display: flex;
            flex-direction: row;
            gap: 1px;
            padding: 3px;
            background: rgba(0,0,0,0.06);
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: fit-content;
        }
        
        .ten-block {
            width: 18px; height: 18px; 
            background: var(--block-ten);
            border: 1px solid #00b0ad;
            border-radius: 2px;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.1);
        }

        .one-cube {
            width: 24px; height: 24px; 
            background: var(--block-one);
            border: 1.5px solid #e19a8a;
            border-radius: 4px;
            box-shadow: inset 0 -3px 0 rgba(0,0,0,0.15);
        }

        .dimmed {
            visibility: hidden; 
            opacity: 0;
            pointer-events: none;
        }

        .controls-bank {
            background: white;
            padding: 12px;
            border-radius: 20px;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
        }
        .ctrl-btn {
            flex: 1;
            background: #f8f9fa;
            border: 2px solid #eee;
            border-radius: 15px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            box-shadow: 0 4px 0 #ddd;
        }
        .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        .ctrl-label { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: #666; }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-bottom: 10px;
            position: relative;
        }
        .opt-btn {
            height: 55px;
            background: white;
            border-radius: 15px;
            font-family: var(--font-title);
            font-size: 1.8rem;
            box-shadow: 0 5px 0 rgba(0,0,0,0.1);
            border: 2px solid #eee;
            cursor: pointer;
        }
        .opt-btn.correct { background: var(--c-green); color: white; border-color: #00a383; box-shadow: 0 5px 0 #008f72; }
        .opt-btn.wrong { background: var(--c-red); color: white; border-color: #e84118; box-shadow: 0 5px 0 #c23616; }

        #answer-feedback {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-title);
            font-size: 1.4rem;
            white-space: nowrap;
            pointer-events: none;
        }

        @media (min-width: 600px) {
            .title-main { font-size: 4rem; }
            .eq-nums { font-size: 2.8rem; }
            .title-group h1 { font-size: 1.8rem; }
            .ten-block { width: 22px; height: 22px; }
            .one-cube { width: 28px; height: 28px; }
            .col-section { gap: 10px; }
        }

        #bonus-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            overflow: hidden;
        }
        .balloon {
            position: absolute;
            width: 70px; height: 90px;
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            cursor: pointer;
            box-shadow: inset -5px -5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <header>
        <div class="title-group">
            <h1>SUBTRACTING BLOCKS</h1>
        </div>
        <div class="controls">
             <button class="btn-icon" id="btn-undo" onclick="undoAction()" title="Undo">‚Ü©Ô∏è</button>
             <button class="btn-icon" onclick="resetGame()" title="Reset">üîÑ</button>
             <button class="btn-icon" onclick="speakEquation()" title="Listen">üîä</button>
        </div>
        <div class="score-board">SCORE: <span id="score-display">0</span></div>
    </header>

    <div id="app">
        <div id="start-screen">
            <h1 class="title-main">Let's Subtract!</h1>
            <p class="subtitle">Solve math with blocks!</p>
            <button class="btn-primary" onclick="goToSetup()">START GAME ‚ñ∂</button>
        </div>

        <div id="setup-screen" class="hidden">
            <h1 class="title-main">Select Range</h1>
            <p class="subtitle">Choose the maximum number</p>
            <div class="level-grid">
                <button class="level-btn" onclick="startLevel(10)">10</button>
                <button class="level-btn" onclick="startLevel(20)">20</button>
                <button class="level-btn" onclick="startLevel(30)">30</button>
                <button class="level-btn" onclick="startLevel(50)">50</button>
                <button class="level-btn" onclick="startLevel(100)">100</button>
            </div>
            <button class="btn-primary" onclick="resetGame()" style="font-size: 1rem; padding: 10px 30px; margin-top: 15px;">BACK</button>
        </div>

        <div id="playing-screen" class="hidden">
            <div class="equation-bar">
                <div class="eq-nums">
                    <span style="color:var(--c-blue)" id="eq-n1">0</span>
                    <span style="color:#b2bec3">‚àí</span>
                    <span style="color:var(--c-red)" id="eq-n2">0</span>
                    <span style="color:#b2bec3">= ?</span>
                </div>
            </div>

            <div class="notification-area">
                <div id="notification-bubble" class="notif-bubble hidden">Ready!</div>
            </div>

            <div class="board-container">
                <div class="board-headers">
                    <div class="col-header header-tens">Tens</div>
                    <div class="col-header header-ones">Ones</div>
                </div>
                <div style="font-size:0.7rem; text-align:center; color:var(--c-blue); font-weight:800; margin-bottom:5px;">Drag a Ten to Ones to break it!</div>
                <div class="board-cols">
                    <div class="col" id="tens-col"></div>
                    <div class="col" id="ones-col"></div>
                </div>
            </div>

            <div class="controls-bank">
                <button class="ctrl-btn" id="btn-sub-ten" onclick="subTen()">
                    <div class="ten-rod" style="transform: scale(0.4);">
                        <div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div><div class="ten-block"></div>
                    </div>
                    <span class="ctrl-label">Remove Ten</span>
                </button>
                <button class="ctrl-btn" id="btn-sub-one" onclick="subOne()">
                    <div class="one-cube" style="transform: scale(0.7)"></div>
                    <span class="ctrl-label">Remove One</span>
                </button>
            </div>

            <div class="options-grid" id="options-grid">
                <div id="answer-feedback"></div>
            </div>
        </div>

        <div id="finished-screen" class="hidden">
            <div style="text-align:center;">
                <div style="font-size: 5rem;">üèÜ</div>
                <h1 style="color: var(--c-purple); font-family: var(--font-title); font-size: 3rem; margin: 0;">AMAZING!</h1>
                <p style="color: #666; font-size: 1.2rem; font-weight:600;">Final Score: <span id="final-score" style="color: var(--c-blue); font-weight: 900;">0</span></p>
                <button class="btn-primary" onclick="resetGame()" style="background: var(--c-blue); color: white; margin-top: 15px;">PLAY AGAIN</button>
            </div>
        </div>

        <div id="bonus-overlay">
            <div style="position: absolute; top: 10%; width: 100%; text-align: center; color: white;">
                <h2 style="font-family: var(--font-title); font-size: 4rem; color: var(--c-yellow); margin: 0; text-shadow: 0 4px 10px rgba(0,0,0,0.5);">BONUS!</h2>
                <p style="font-size: 1.2rem; font-weight: 800;">Pop the balloons for extra points!</p>
            </div>
            <div id="balloon-container"></div>
        </div>
    </div>

    <script>
        let state = {
            phase: 'start', 
            score: 0,
            questionIndex: 0,
            maxRange: 100,
            question: { n1: 0, n2: 0, ans: 0 },
            options: [],
            layout: { tens: 0, ones: 0 }, 
            removed: { tens: 0, ones: 0 },
            history: [],
            feedback: null,
            selectedOption: null,
            bonusActive: false
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const ctx = audioCtx;
            const now = ctx.currentTime;
            if (type === 'pop') {
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.setValueAtTime(700, now);
                o.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                g.gain.setValueAtTime(0.1, now);
                o.start(); o.stop(now + 0.1);
            } else if (type === 'success') {
                [523, 659, 783, 1046].forEach((f, i) => {
                    const o = ctx.createOscillator(); const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.type = 'sine'; o.frequency.value = f;
                    g.gain.setValueAtTime(0, now + i*0.08);
                    g.gain.linearRampToValueAtTime(0.08, now + i*0.08 + 0.04);
                    g.gain.linearRampToValueAtTime(0, now + i*0.08 + 0.15);
                    o.start(now + i*0.08); o.stop(now + i*0.08 + 0.15);
                });
            } else if (type === 'wrong') {
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.type = 'triangle'; o.frequency.setValueAtTime(120, now);
                o.frequency.linearRampToValueAtTime(80, now + 0.2);
                g.gain.setValueAtTime(0.1, now);
                o.start(); o.stop(now + 0.2);
            } else if (type === 'magic') {
                const o = ctx.createOscillator(); const g = ctx.createGain();
                o.connect(g); g.connect(ctx.destination);
                o.frequency.setValueAtTime(400, now);
                o.frequency.exponentialRampToValueAtTime(1500, now + 0.3);
                g.gain.setValueAtTime(0.05, now);
                o.start(); o.stop(now + 0.3);
            }
        }

        function speakEquation() {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(`${state.question.n1} minus ${state.question.n2}`);
                u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u);
            }
        }

        function saveToHistory() {
            state.history.push(JSON.parse(JSON.stringify({
                layout: state.layout,
                removed: state.removed
            })));
            document.getElementById('btn-undo').disabled = false;
        }

        function undoAction() {
            if (state.history.length === 0) return;
            const prevState = state.history.pop();
            state.layout = prevState.layout;
            state.removed = prevState.removed;
            playSound('pop');
            updateUI();
        }

        function goToSetup() {
            state.phase = 'setup';
            updateUI();
            playSound('pop');
        }

        function startLevel(range) {
            state.maxRange = range;
            state.score = 0;
            state.questionIndex = 0;
            state.phase = 'playing';
            initDragAndDrop(); // Init DND once
            generateQuestion();
            updateUI();
            playSound('magic');
        }

        function generateQuestion() {
            const range = state.maxRange;
            const minN1 = range <= 10 ? 5 : Math.floor(range / 2);
            const n1 = Math.floor(Math.random() * (range - minN1 + 1)) + minN1;
            const n2 = Math.floor(Math.random() * (n1 - 1)) + 1;
            const ans = n1 - n2;
            const opts = [ans];
            while(opts.length < 4) {
                const o = ans + Math.floor(Math.random() * 11) - 5;
                if(o >= 0 && o <= range && !opts.includes(o)) opts.push(o);
            }
            state.question = { n1, n2, ans };
            state.options = opts.sort(() => Math.random() - 0.5);
            state.layout = { tens: Math.floor(n1/10), ones: n1 % 10 };
            state.removed = { tens: 0, ones: 0 };
            state.history = [];
            state.feedback = null;
            state.selectedOption = null;
            const feedbackEl = document.getElementById('answer-feedback');
            if(feedbackEl) feedbackEl.innerHTML = "";
            document.getElementById('btn-undo').disabled = true;
        }

        function resetGame() {
            state.phase = 'start'; state.bonusActive = false; state.history = [];
            updateUI();
        }

        function subTen() {
            const targetTens = Math.floor(state.question.n2 / 10);
            const activeTens = state.layout.tens - state.removed.tens;
            if (state.removed.tens < targetTens && activeTens > 0) {
                saveToHistory();
                state.removed.tens++;
                playSound('pop');
                updateBoard();
            } else if (state.removed.tens >= targetTens) {
                showNotification("Enough tens removed!");
            } else {
                showNotification("No tens to remove!");
            }
        }

        function subOne() {
            const targetOnes = state.question.n2 % 10;
            const activeOnes = state.layout.ones - state.removed.ones;
            if (state.removed.ones < targetOnes && activeOnes > 0) {
                saveToHistory();
                state.removed.ones++;
                playSound('pop');
                updateBoard();
            } else if (state.removed.ones >= targetOnes) {
                showNotification("Enough ones removed!");
            } else {
                showNotification("No ones! Drag a Ten to Ones.");
            }
        }

        function breakTen() {
            const activeTens = state.layout.tens - state.removed.tens;
            if (activeTens > 0) {
                saveToHistory();
                state.layout.tens--;
                state.layout.ones += 10;
                playSound('magic'); 
                showNotification("Unbundled 1 Ten!");
                updateBoard();
            } else {
                showNotification("No tens left!");
            }
        }

        function handleAnswer(val) {
            if (state.feedback) return;
            state.selectedOption = val;
            const feedbackEl = document.getElementById('answer-feedback');
            if (val === state.question.ans) {
                playSound('success'); state.feedback = 'correct'; state.score += 10;
                feedbackEl.innerHTML = `<span style="color:var(--c-green)">Good job! üåü</span>`;
                setTimeout(startBonusRound, 1200);
            } else {
                playSound('wrong'); state.feedback = 'wrong';
                feedbackEl.innerHTML = `<span style="color:var(--c-red)">Try again! ‚ùå</span>`;
                setTimeout(() => { 
                    state.feedback = null; state.selectedOption = null;
                    feedbackEl.innerHTML = ""; updateUI(); 
                }, 1200);
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('start-screen').classList.toggle('hidden', state.phase !== 'start');
            document.getElementById('setup-screen').classList.toggle('hidden', state.phase !== 'setup');
            document.getElementById('playing-screen').classList.toggle('hidden', state.phase !== 'playing');
            document.getElementById('finished-screen').classList.toggle('hidden', state.phase !== 'finished');
            if (state.phase === 'playing') {
                document.getElementById('score-display').innerText = state.score;
                document.getElementById('eq-n1').innerText = state.question.n1;
                document.getElementById('eq-n2').innerText = state.question.n2;
                updateBoard(); renderOptions();
                document.getElementById('btn-undo').disabled = state.history.length === 0;
            }
        }

        function updateBoard() {
            const tensCol = document.getElementById('tens-col');
            tensCol.innerHTML = '';
            for(let i=0; i<state.layout.tens; i++) {
                const rod = createRod();
                if (i >= state.layout.tens - state.removed.tens) {
                    rod.classList.add('dimmed'); rod.draggable = false;
                } else {
                    rod.draggable = true;
                    rod.addEventListener('dragstart', (e) => e.dataTransfer.setData('text/plain', 'ten-rod'));
                }
                tensCol.appendChild(rod);
            }
            const onesCol = document.getElementById('ones-col');
            onesCol.innerHTML = '';
            const section = document.createElement('div'); section.className = 'col-section';
            for(let i=0; i<state.layout.ones; i++) {
                const cube = document.createElement('div'); cube.className = 'one-cube';
                if (i >= state.layout.ones - state.removed.ones) cube.classList.add('dimmed');
                section.appendChild(cube);
            }
            onesCol.appendChild(section);

            const doneTens = state.removed.tens === Math.floor(state.question.n2 / 10);
            const doneOnes = state.removed.ones === (state.question.n2 % 10);
            document.querySelectorAll('.opt-btn').forEach(btn => btn.disabled = !(doneTens && doneOnes));
            document.getElementById('btn-undo').disabled = state.history.length === 0;
        }

        function initDragAndDrop() {
            const onesCol = document.getElementById('ones-col');
            // Remove old ones to avoid duplicates if re-init
            const newOnes = onesCol.cloneNode(true);
            onesCol.parentNode.replaceChild(newOnes, onesCol);
            
            newOnes.addEventListener('dragover', (e) => { e.preventDefault(); newOnes.classList.add('drag-over'); });
            newOnes.addEventListener('dragleave', () => newOnes.classList.remove('drag-over'));
            newOnes.addEventListener('drop', (e) => {
                e.preventDefault();
                newOnes.classList.remove('drag-over');
                if (e.dataTransfer.getData('text/plain') === 'ten-rod') {
                    breakTen();
                }
            });
        }

        function createRod() {
            const rod = document.createElement('div'); rod.className = 'ten-rod';
            for(let j=0; j<10; j++) rod.appendChild(document.createElement('div')).className = 'ten-block';
            return rod;
        }

        function renderOptions() {
            const grid = document.getElementById('options-grid');
            const feedbackEl = document.getElementById('answer-feedback');
            grid.innerHTML = ''; grid.appendChild(feedbackEl);
            state.options.forEach(opt => {
                const btn = document.createElement('button'); btn.className = 'opt-btn';
                btn.innerText = opt;
                if (state.selectedOption === opt) btn.classList.add(state.feedback);
                btn.onclick = () => handleAnswer(opt); grid.appendChild(btn);
            });
        }

        function showNotification(msg) {
            const el = document.getElementById('notification-bubble'); el.innerText = msg;
            el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 2000);
        }

        function startBonusRound() {
            state.bonusActive = true;
            const overlay = document.getElementById('bonus-overlay');
            overlay.style.display = 'block';
            const container = document.getElementById('balloon-container');
            container.innerHTML = '';
            const colors = ['#ff7675', '#74b9ff', '#55efc4', '#ffeaa7', '#a29bfe', '#fab1a0'];
            for(let i=0; i<15; i++) {
                const b = document.createElement('div');
                b.className = 'balloon'; b.style.left = (Math.random()*85+5)+'%';
                b.style.top = '105%'; b.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                let y = 105; const speed = 0.3 + Math.random()*0.4;
                const move = () => {
                    if(!state.bonusActive) return;
                    y -= speed; b.style.top = y + '%';
                    if(y > -20) requestAnimationFrame(move);
                };
                const pop = (e) => {
                    e.preventDefault(); playSound('pop'); b.remove(); 
                    state.score += 2; document.getElementById('score-display').innerText = state.score; 
                };
                b.onmousedown = pop; b.ontouchstart = pop;
                container.appendChild(b); move();
            }
            setTimeout(() => {
                state.bonusActive = false; overlay.style.display = 'none';
                state.questionIndex++;
                if(state.questionIndex < 10) { generateQuestion(); updateUI(); }
                else { state.phase = 'finished'; document.getElementById('final-score').innerText = state.score; updateUI(); playSound('success'); }
            }, 4500);
        }
    </script>
</body>
</html>
