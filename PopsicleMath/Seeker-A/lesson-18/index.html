<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bridge Master: Professional Construction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        /* --- Giao di·ªán n·ªÅn tr·ªùi --- */
        .sky-bg {
            background: linear-gradient(to bottom, #0ea5e9 0%, #38bdf8 40%, #bae6fd 100%);
            position: relative;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .sun {
            position: absolute;
            top: -40px;
            left: -40px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #fde047 20%, #facc15 60%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 40px 20px rgba(253, 224, 71, 0.5);
            animation: sun-glow 4s infinite alternate;
            z-index: 0;
        }

        @keyframes sun-glow {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.1); opacity: 1; }
        }

        .cloud-base {
            position: absolute;
            color: white;
            opacity: 0.9;
            text-shadow: 0 4px 10px rgba(0,0,0,0.1);
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.05));
            pointer-events: none;
        }
        
        .cloud-move-1 { animation: float 45s infinite linear; }
        .cloud-move-2 { animation: float 35s infinite linear reverse; }
        .cloud-move-3 { animation: float 55s infinite linear; }

        @keyframes float {
            from { transform: translateX(-120px); }
            to { transform: translateX(100vw); }
        }

        canvas {
            display: block;
            position: relative;
            z-index: 10;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .interactive { pointer-events: auto; }

        .pop-in {
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        #fireworksCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 60;
        }

        .math-card {
            background: white;
            border: 8px solid #fbbf24;
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="sky-bg">
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <!-- Trang tr√≠ n·ªÅn -->
    <div class="sun"></div>
    <div class="cloud-base text-7xl cloud-move-1" style="top: 5%; left: -10%;">‚òÅÔ∏è</div>
    <div class="cloud-base text-5xl cloud-move-2" style="top: 15%; right: -10%; opacity: 0.7;">‚òÅÔ∏è</div>
    <div class="cloud-base text-8xl cloud-move-3" style="top: 10%; left: -20%; opacity: 0.6; animation-delay: -20s;">‚òÅÔ∏è</div>

    <canvas id="fireworksCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>

    <div class="ui-layer">
        <!-- Hi·ªÉn th·ªã ƒëi·ªÉm s·ªë -->
        <header class="w-full p-4 flex justify-center items-center">
            <div id="scoreBox" class="bg-white/90 backdrop-blur rounded-2xl px-6 py-2 border-4 border-yellow-400 shadow-lg opacity-0 transition-opacity duration-500">
                <span class="text-2xl font-bold text-yellow-600">üèÜ Project Progress: <span id="currentScore">0</span>/10</span>
            </div>
        </header>

        <!-- H∆∞·ªõng d·∫´n -->
        <div id="hint" class="absolute bottom-44 text-white font-bold text-xl drop-shadow-md animate-bounce opacity-0">
            HOLD TO CONSTRUCT!
        </div>

        <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
        <div id="startScreen" class="absolute inset-0 flex items-center justify-center bg-black/30 backdrop-blur-sm interactive">
            <div class="bg-white rounded-3xl p-8 max-w-md w-[90%] text-center shadow-2xl border-8 border-yellow-400 pop-in">
                <h1 class="text-5xl font-bold text-yellow-600 mb-2">Bridge Master</h1>
                <h2 class="text-xl font-semibold text-slate-500 mb-6 uppercase tracking-wider">üë∑ Master Constructor</h2>
                
                <div class="flex justify-center gap-8 mb-8 text-7xl">
                    <div class="animate-bounce" style="animation-delay: 0s">üèóÔ∏è</div>
                    <div class="animate-bounce" style="animation-delay: 0.2s">üåâ</div>
                </div>

                <p class="text-slate-600 mb-8 font-medium italic">"Link Point A to the Skyscraper at Point B!"</p>

                <button id="startBtn" class="w-full bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-4 px-6 rounded-2xl shadow-[0_6px_0_rgb(21,128,61)] active:shadow-[0_2px_0_rgb(21,128,61)] active:translate-y-1 transition transform">
                    START PROJECT
                </button>
            </div>
        </div>

        <!-- M√†n h√¨nh th·ª≠ th√°ch To√°n h·ªçc -->
        <div id="mathRevivalScreen" class="hidden absolute inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm interactive">
            <div class="math-card max-w-md w-[90%] text-center pop-in">
                <h2 class="text-3xl font-bold text-yellow-600 mb-2">URGENT REPAIRS! üõ†Ô∏è</h2>
                <p class="text-slate-500 mb-6 font-semibold">Solve the blueprint to rescue the worker!</p>
                
                <div id="mathQuestion" class="text-5xl font-black text-slate-800 mb-8 bg-yellow-50 py-6 rounded-2xl border-4 border-yellow-100">
                    ? + ? = ?
                </div>
                
                <div id="mathOptions" class="grid grid-cols-2 gap-4">
                    <!-- C√°c n√∫t ƒë∆∞·ª£c t·∫°o b·∫±ng JS -->
                </div>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt th√∫c -->
        <div id="gameOverScreen" class="hidden absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm interactive">
            <div id="gameOverCard" class="bg-white rounded-3xl p-8 max-w-md w-[90%] text-center shadow-2xl border-8 border-red-400 pop-in">
                <h1 class="text-4xl font-bold text-red-600 mb-4">PROJECT HALTED!</h1>
                <div class="text-7xl mb-6">üêä</div>
                <p id="failReason" class="text-slate-600 font-bold mb-6 text-lg">Safety alert! Man overboard!</p>
                
                <div class="bg-red-50 rounded-2xl p-4 mb-6 border-2 border-red-100">
                    <div class="text-red-400 text-sm uppercase font-bold">Total Progress</div>
                    <div id="finalScore" class="text-5xl font-bold text-slate-800">0/10</div>
                </div>

                <button id="retryBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-bold py-4 rounded-2xl shadow-[0_6px_0_rgb(29,78,216)] active:shadow-[0_2px_0_rgb(29,78,216)] active:translate-y-1 transition transform">
                    RETRY PROJECT ‚Ü∫
                </button>
            </div>
        </div>

        <!-- M√†n h√¨nh ch√∫c m·ª´ng -->
        <div id="congratsScreen" class="hidden absolute inset-0 flex items-center justify-center bg-yellow-400/20 backdrop-blur-sm interactive">
            <div class="bg-white rounded-3xl p-8 text-center shadow-2xl border-8 border-green-400 pop-in">
                <h1 class="text-5xl font-bold text-green-600 mb-4">MISSION COMPLETE!</h1>
                <div class="text-8xl mb-6">üèÜüåâüèóÔ∏èüéÜ</div>
                <p class="text-slate-600 font-bold mb-8 text-xl">The Sky-Link to Point B is finished!</p>
                <button id="finalResetBtn" class="w-full bg-green-500 hover:bg-green-600 text-white text-2xl font-bold py-4 rounded-2xl shadow-[0_6px_0_rgb(21,128,61)] active:shadow-[0_2px_0_rgb(21,128,61)] active:translate-y-1 transition transform">
                    START NEW CONTRACT
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const fwCanvas = document.getElementById('fireworksCanvas');
        const fwCtx = fwCanvas.getContext('2d');
        
        // C·∫•u h√¨nh game
        const STICK_GROWTH_SPEED = 5.5;
        const PLATFORM_Y_OFFSET = 120; 
        const MIN_PLATFORM_WIDTH = 60;
        const MAX_PLATFORM_WIDTH = 130;
        const MIN_GAP = 120;
        const MAX_GAP = 320;

        // Tr·∫°ng th√°i game
        let score = 0;
        let gameActive = false;
        let isHolding = false;
        let state = 'waiting'; 
        let platforms = [];
        let placedSticks = []; // Danh s√°ch c√°c thanh c·∫ßu ƒë√£ x√¢y th√†nh c√¥ng
        let stick = { x: 0, y: 0, length: 0, angle: 0 };
        let character = { x: 0, y: 0, targetX: 0 };
        let cameraX = 0;
        let targetCameraX = 0;

        // Ph√°o hoa
        let fwParticles = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            fwCanvas.width = window.innerWidth;
            fwCanvas.height = window.innerHeight;
            if (gameActive) draw();
        }
        window.addEventListener('resize', resize);
        resize();

        function initGame() {
            score = 0;
            platforms = [];
            placedSticks = [];
            cameraX = 0;
            targetCameraX = 0;
            
            platforms.push({ x: 100, width: 160 });
            addPlatform();
            
            character.x = platforms[0].x + platforms[0].width - 50;
            character.y = canvas.height - PLATFORM_Y_OFFSET;
            character.targetX = character.x;
            
            stick.length = 0;
            stick.angle = -Math.PI / 2;
            stick.x = platforms[0].x + platforms[0].width;
            stick.y = canvas.height - PLATFORM_Y_OFFSET;

            state = 'waiting';
            updateUI();
        }

        function addPlatform() {
            const last = platforms[platforms.length - 1];
            const gap = MIN_GAP + Math.random() * (MAX_GAP - MIN_GAP);
            const width = (score >= 9) ? 240 : MIN_PLATFORM_WIDTH + Math.random() * (MAX_PLATFORM_WIDTH - MIN_PLATFORM_WIDTH);
            platforms.push({
                x: last.x + last.width + gap,
                width: width
            });
        }

        function update() {
            if (!gameActive && state !== 'congrats') {
                if (fwParticles.length > 0) drawFireworks();
                return;
            }

            const lerpFactor = state === 'transitioning' ? 0.05 : 0.08;
            cameraX += (targetCameraX - cameraX) * lerpFactor;

            if (state === 'growing' && isHolding) {
                stick.length += STICK_GROWTH_SPEED;
            }

            if (state === 'falling') {
                stick.angle += 0.18;
                
                const landingX = stick.x + stick.length;
                const target = platforms[1];
                const isTooLong = landingX > target.x + target.width;
                const isTooShort = landingX < target.x;

                // N·∫øu thanh c·∫ßu ƒëang r∆°i ƒë·∫øn v·ªã tr√≠ n·∫±m ngang (0 ƒë·ªô)
                if (stick.angle >= 0) {
                    if (isSuccess() || isTooLong) {
                        // N·∫æU TH√ÄNH C√îNG HO·∫∂C QU√Å D√ÄI: D·ª´ng l·∫°i ·ªü 0 ƒë·ªô
                        stick.angle = 0;
                        state = 'walking';
                        if (isSuccess()) {
                            character.targetX = target.x + target.width - 50;
                        } else {
                            // Qu√° d√†i: ƒêi t·ªõi cu·ªëi thanh c·∫ßu
                            character.targetX = landingX + 35; 
                        }
                    } else if (isTooShort) {
                        // N·∫æU QU√Å NG·∫ÆN: Ti·∫øp t·ª•c r∆°i xu·ªëng 90 ƒë·ªô (PI/2)
                        if (stick.angle >= Math.PI / 2) {
                            stick.angle = Math.PI / 2;
                            state = 'walking';
                            character.targetX = stick.x + 5; // ƒêi t·ªõi m√©p r·ªìi r∆°i
                        }
                    }
                }
            }

            if (state === 'walking') {
                character.x += 4.5;
                if (character.x >= character.targetX) {
                    character.x = character.targetX;
                    if (isSuccess()) {
                        // L∆∞u l·∫°i thanh c·∫ßu ƒë√£ ho√†n th√†nh
                        placedSticks.push({
                            x: stick.x, 
                            y: stick.y, 
                            length: stick.length, 
                            angle: 0
                        });
                        score++;
                        updateUI();
                        if (score >= 10) triggerCompletion();
                        else nextTurn();
                    } else {
                        state = 'falling_down';
                    }
                }
            }

            if (state === 'falling_down') {
                character.y += 12;
                if (character.y > canvas.height + 150) {
                    triggerMathChallenge();
                }
            }

            draw();
            drawFireworks();
            requestAnimationFrame(update);
        }

        function isSuccess() {
            const landingX = stick.x + stick.length;
            const target = platforms[1];
            return landingX >= target.x && landingX <= target.x + target.width;
        }

        function nextTurn() {
            state = 'transitioning';
            setTimeout(() => {
                targetCameraX = platforms[1].x - 100;
                setTimeout(() => {
                    platforms.shift();
                    addPlatform();
                    stick.length = 0;
                    stick.angle = -Math.PI / 2;
                    stick.x = platforms[0].x + platforms[0].width;
                    state = 'waiting';
                }, 600);
            }, 300);
        }

        // --- V·∫º NH√ÇN V·∫¨T C√îNG NH√ÇN ---
        function drawWorker(x, y) {
            ctx.save();
            ctx.translate(x, y);

            const time = Date.now() * 0.01;
            const isWalking = (state === 'walking');
            const cycle = isWalking ? Math.sin(time) : 0;
            const cycleAlt = isWalking ? Math.sin(time + Math.PI) : 0;
            const bob = isWalking ? Math.abs(Math.sin(time * 2)) * 4 : 0;
            const bodyTilt = isWalking ? Math.sin(time) * 0.04 : 0;

            ctx.translate(0, -bob);
            ctx.rotate(bodyTilt);

            const hipX = 0, hipY = -35; 
            drawRealisticLeg(cycleAlt, hipX, hipY, isWalking, true);  
            drawRealisticLeg(cycle, hipX, hipY, isWalking, false);    

            const vestGrad = ctx.createLinearGradient(-16, -70, 16, hipY);
            vestGrad.addColorStop(0, '#ea580c');
            vestGrad.addColorStop(1, '#9a3412');
            ctx.fillStyle = '#1e3a8a';
            ctx.beginPath(); ctx.roundRect(-14, -70, 28, 35, 4); ctx.fill();
            ctx.fillStyle = vestGrad;
            ctx.beginPath(); ctx.roundRect(-16, -70, 32, 35, 6); ctx.fill();
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(-16, -64, 32, 4.5);
            ctx.fillRect(-16, -48, 32, 4.5);
            ctx.fillRect(-2.5, -70, 5, 35); 

            drawRealisticArm(cycleAlt, -15, -64, true);  
            drawRealisticArm(cycle, 15, -64, false);     

            ctx.fillStyle = '#f59e0b';
            ctx.beginPath(); ctx.arc(0, -86, 15, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#451a03';
            ctx.beginPath(); ctx.arc(0, -90, 15, Math.PI, 0); ctx.fill();
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath(); ctx.arc(-14, -86, 3, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(14, -86, 3, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#000';
            ctx.beginPath(); ctx.arc(-6, -88, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(6, -88, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = '#000'; ctx.lineWidth = 1.5;
            ctx.beginPath(); ctx.arc(0, -82, 5, 0.2, Math.PI - 0.2); ctx.stroke();

            const hatGrad = ctx.createLinearGradient(-22, -110, 22, -90);
            hatGrad.addColorStop(0, '#fbbf24');
            hatGrad.addColorStop(1, '#b45309');
            ctx.fillStyle = hatGrad;
            ctx.beginPath(); ctx.ellipse(0, -98, 20, 16, 0, Math.PI, 0); ctx.fill();
            ctx.beginPath(); ctx.roundRect(-26, -100, 52, 6, 3); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.beginPath(); ctx.arc(-10, -106, 5, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        function drawRealisticLeg(cycle, hipX, hipY, isWalking, isBack) {
            ctx.save();
            ctx.translate(hipX, hipY);
            const thighAngle = isWalking ? cycle * 0.45 : 0;
            ctx.rotate(thighAngle);
            ctx.fillStyle = isBack ? '#1e3a8a' : '#2563eb';
            ctx.beginPath(); ctx.roundRect(-7, 0, 14, 22, 6); ctx.fill();
            ctx.translate(0, 18);
            const kneeAngle = isWalking ? (cycle > 0 ? cycle * 0.5 : 0) : 0;
            ctx.rotate(kneeAngle);
            ctx.beginPath(); ctx.roundRect(-6.5, 0, 13, 20, 5); ctx.fill();
            ctx.translate(0, 17);
            ctx.rotate(-thighAngle - kneeAngle); 
            ctx.fillStyle = isBack ? '#2d1406' : '#451a03';
            ctx.beginPath(); ctx.roundRect(-8, 0, 23, 13, 4); ctx.fill();
            ctx.fillStyle = '#000'; ctx.fillRect(-8, 9, 23, 4);
            ctx.restore();
        }

        function drawRealisticArm(cycle, x, y, isLeft) {
            ctx.save(); ctx.translate(x, y);
            ctx.rotate(-cycle * 0.5);
            ctx.fillStyle = '#2563eb';
            ctx.beginPath(); ctx.roundRect(-5, 0, 10, 18, 4); ctx.fill();
            ctx.translate(0, 15);
            ctx.rotate(Math.abs(cycle) * 0.3);
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(-4.5, 0, 9, 12);
            ctx.fillStyle = '#475569';
            ctx.beginPath(); ctx.arc(0, 15, 7, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        // --- ƒê·ªí H·ªåA TR·ª§ C·∫¶U ---
        function drawAdvancedPlatform(p, isTarget, isLast) {
            const h = PLATFORM_Y_OFFSET;
            const topHeight = 22; 
            ctx.save();
            ctx.fillStyle = 'rgba(0,0,0,0.25)';
            ctx.beginPath(); ctx.roundRect(p.x + 12, canvas.height - h + 12, p.width, h, 14); ctx.fill();
            const bodyGrad = ctx.createLinearGradient(p.x, canvas.height - h, p.x + p.width, canvas.height - h);
            bodyGrad.addColorStop(0, '#94a3b8'); bodyGrad.addColorStop(0.5, '#cbd5e1'); bodyGrad.addColorStop(1, '#64748b');
            ctx.fillStyle = bodyGrad;
            ctx.beginPath(); ctx.roundRect(p.x, canvas.height - h, p.width, h, 14); ctx.fill();
            ctx.strokeStyle = 'rgba(71, 85, 105, 0.4)'; ctx.lineWidth = 4; ctx.beginPath();
            const segmentH = (h - topHeight) / 2;
            for(let i=0; i<2; i++) {
                const yOffset = canvas.height - h + topHeight + (i * segmentH);
                ctx.moveTo(p.x + 10, yOffset + 10); ctx.lineTo(p.x + p.width - 10, yOffset + segmentH - 10);
                ctx.moveTo(p.x + p.width - 10, yOffset + 10); ctx.lineTo(p.x + 10, yOffset + segmentH - 10);
            }
            ctx.stroke();
            const capColor = isLast ? '#22c55e' : (isTarget ? '#fbbf24' : '#475569');
            const capGrad = ctx.createLinearGradient(p.x, canvas.height - h, p.x, canvas.height - h + topHeight);
            capGrad.addColorStop(0, capColor); capGrad.addColorStop(1, isLast ? '#166534' : (isTarget ? '#d97706' : '#1e293b'));
            ctx.fillStyle = capGrad;
            ctx.beginPath(); ctx.roundRect(p.x - 4, canvas.height - h, p.width + 8, topHeight, 6); ctx.fill();
            ctx.save(); ctx.beginPath(); ctx.rect(p.x - 4, canvas.height - h + topHeight - 8, p.width + 8, 8); ctx.clip();
            ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = 4;
            for(let i = -20; i < p.width + 20; i += 18) { ctx.beginPath(); ctx.moveTo(p.x + i, canvas.height - h + topHeight); ctx.lineTo(p.x + i + 10, canvas.height - h + topHeight - 15); ctx.stroke(); }
            ctx.restore();
            ctx.fillStyle = '#cbd5e1'; ctx.beginPath(); ctx.arc(p.x + 6, canvas.height - h + 6, 4, 0, Math.PI*2); ctx.arc(p.x + p.width - 6, canvas.height - h + 6, 4, 0, Math.PI*2); ctx.fill();
            if(isTarget && !isLast) {
                const glow = Math.abs(Math.sin(Date.now() * 0.005)) * 5;
                ctx.shadowBlur = glow; ctx.shadowColor = "#ef4444"; ctx.fillStyle = '#ef4444';
                ctx.beginPath(); ctx.arc(p.x + p.width/2, canvas.height - h + topHeight/2, 7, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;
            }
            ctx.restore();
        }

        // --- ƒê·ªí H·ªåA M√îI TR∆Ø·ªúNG & KI·∫æN TR√öC ---
        function drawWorld() {
            const time = Date.now() * 0.002;
            const riverGrad = ctx.createLinearGradient(0, canvas.height - 100, 0, canvas.height);
            riverGrad.addColorStop(0, '#0ea5e9'); riverGrad.addColorStop(1, '#0369a1');
            ctx.fillStyle = riverGrad;
            ctx.fillRect(cameraX, canvas.height - 100, canvas.width, 100);

            ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 3;
            for(let i=0; i<4; i++) {
                ctx.beginPath(); ctx.moveTo(cameraX, canvas.height - 80 + (i*20)); ctx.lineTo(cameraX + canvas.width, canvas.height - 80 + (i*20));
                ctx.setLineDash([50, 60]); ctx.lineDashOffset = time * 30 * (i % 2 === 0 ? 1 : -1); ctx.stroke();
            }
            ctx.setLineDash([]);

            const crocBaseX = cameraX + canvas.width/2 + Math.sin(time * 0.4) * (canvas.width/2.5);
            const crocY = canvas.height - 40 + Math.sin(time * 2.5) * 10;
            drawCrocodile(crocBaseX, crocY, Math.cos(time * 0.4) > 0 ? 1 : -1);

            if (cameraX < 850) drawSiteOffice(-150, canvas.height - 110);
            if (score >= 9) drawBuildingSite(platforms[platforms.length-1].x + 50, canvas.height - 110);
        }

        function drawSiteOffice(x, y) {
            ctx.save(); ctx.translate(x, y);
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.roundRect(0, 0, 700, 150, 20); ctx.fill();
            ctx.fillStyle = '#4ade80'; ctx.fillRect(0, 0, 700, 15);
            ctx.fillStyle = '#f8fafc'; ctx.beginPath(); ctx.roundRect(150, -130, 340, 130, 10); ctx.fill();
            ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = '#1e293b'; ctx.beginPath(); ctx.moveTo(130, -130); ctx.lineTo(510, -130); ctx.lineTo(480, -165); ctx.lineTo(160, -165); ctx.fill();
            const winGrad = ctx.createLinearGradient(0, -100, 0, -50);
            winGrad.addColorStop(0, '#bae6fd'); winGrad.addColorStop(1, '#0ea5e9');
            ctx.fillStyle = winGrad;
            ctx.beginPath(); ctx.roundRect(180, -100, 80, 60, 5); ctx.roundRect(380, -100, 80, 60, 5); ctx.fill();
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();
            ctx.fillStyle = '#64748b'; ctx.beginPath(); ctx.roundRect(290, -90, 60, 90, 5); ctx.fill();
            ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.arc(340, -45, 4, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        function drawBuildingSite(x, y) {
            ctx.save(); ctx.translate(x, y);
            ctx.fillStyle = '#22c55e'; ctx.beginPath(); ctx.roundRect(0, 0, 1500, 150, 20); ctx.fill();
            ctx.fillStyle = '#4ade80'; ctx.fillRect(0, 0, 1500, 15);
            
            const bX = 250, bW = 200, bH = 340;
            const buildGrad = ctx.createLinearGradient(bX, -bH, bX+bW, -bH);
            buildGrad.addColorStop(0, '#0f172a'); buildGrad.addColorStop(0.5, '#334155'); buildGrad.addColorStop(1, '#020617');
            ctx.fillStyle = buildGrad; ctx.beginPath(); ctx.roundRect(bX, -bH, bW, bH, 10); ctx.fill();
            
            for(let r=0; r<7; r++) { for(let c=0; c<4; c++) {
                ctx.globalAlpha = 0.5 + Math.sin(Date.now()*0.001 + r)*0.4;
                const glassGrad = ctx.createLinearGradient(0, -bH + 20 + (r*46), 0, -bH + 20 + (r*46) + 40);
                glassGrad.addColorStop(0, '#38bdf8'); glassGrad.addColorStop(1, '#0369a1');
                ctx.fillStyle = glassGrad;
                ctx.fillRect(bX + 15 + (c*45), -bH + 20 + (r*45), 35, 35);
            }}
            ctx.globalAlpha = 1;

            ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(bX + bW + 40, 0); ctx.lineTo(bX + bW + 40, -420); ctx.stroke();
            ctx.fillStyle = '#f59e0b'; ctx.beginPath(); ctx.roundRect(bX + bW - 150, -430, 400, 18, 5); ctx.fill();
            ctx.strokeStyle = '#475569'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(bX + bW + 200, -410); ctx.lineTo(bX + bW + 200, -250); ctx.stroke();
            ctx.fillStyle = '#1e293b'; ctx.beginPath(); ctx.arc(bX + bW + 200, -250, 10, 0, Math.PI*2); ctx.fill();
            
            if(Math.floor(Date.now()/500) % 2 === 0) {
                ctx.fillStyle = '#f43f5e'; ctx.beginPath(); ctx.arc(bX + 100, -bH - 15, 10, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }

        function drawCrocodile(x, y, scale = 1) {
            ctx.save(); ctx.translate(x, y); ctx.scale(scale, 1);
            const swing = Math.sin(Date.now() * 0.005) * 15;
            ctx.fillStyle = '#14532d'; ctx.beginPath(); ctx.moveTo(-50, 0); ctx.quadraticCurveTo(-100, swing, -140, 0); ctx.lineTo(-50, 8); ctx.fill();
            ctx.fillStyle = '#166534'; ctx.beginPath(); ctx.ellipse(0, 0, 70, 18, 0, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.moveTo(50, -8); ctx.lineTo(120, -5); ctx.lineTo(120, 10); ctx.lineTo(50, 15); ctx.fill();
            ctx.fillStyle = '#fff'; for(let i=70; i<110; i+=10) { ctx.beginPath(); ctx.moveTo(i, 8); ctx.lineTo(i+4, 15); ctx.lineTo(i+8, 8); ctx.fill(); }
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(60, -6, 5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#facc15'; ctx.beginPath(); ctx.arc(62, -6, 2.5, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#064e3b'; for(let i=-45; i<45; i+=15) { ctx.beginPath(); ctx.moveTo(i, -14); ctx.lineTo(i+8, -28); ctx.lineTo(i+16, -14); ctx.fill(); }
            ctx.restore();
        }

        // --- H√ÄM V·∫º CH√çNH ---
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.translate(-cameraX, 0);
            drawWorld();
            
            platforms.forEach((p, index) => {
                const isTarget = (index === 1), isLast = (isTarget && score >= 9);
                drawAdvancedPlatform(p, isTarget, isLast);
            });

            // V·∫Ω c√°c thanh c·∫ßu ƒë√£ x√¢y xong (Vƒ©nh vi·ªÖn n·∫±m ngang)
            placedSticks.forEach(s => {
                ctx.save();
                ctx.translate(s.x, s.y);
                ctx.rotate(0); 
                ctx.lineWidth = 14; 
                ctx.strokeStyle = '#3d1a03'; 
                ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(s.length, 0); ctx.stroke();
                ctx.fillStyle = '#94a3b8';
                if(s.length > 30) { 
                    ctx.beginPath(); ctx.arc(15, 0, 5, 0, Math.PI*2); ctx.fill(); 
                    ctx.beginPath(); ctx.arc(s.length - 15, 0, 5, 0, Math.PI*2); ctx.fill(); 
                }
                ctx.restore();
            });

            // V·∫Ω thanh c·∫ßu hi·ªán t·∫°i
            ctx.save(); ctx.translate(stick.x, stick.y); ctx.rotate(stick.angle);
            ctx.lineWidth = 14; ctx.strokeStyle = '#3d1a03'; ctx.lineCap = 'round';
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(stick.length, 0); ctx.stroke();
            ctx.fillStyle = '#94a3b8'; 
            if(stick.length > 30) { 
                ctx.beginPath(); ctx.arc(15, 0, 5, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.arc(stick.length - 15, 0, 5, 0, Math.PI*2); ctx.fill(); 
            }
            ctx.restore();

            drawWorker(character.x, character.y);
            ctx.restore();
        }

        // --- H·ªÜ TH·ªêNG TO√ÅN H·ªåC ---
        function triggerMathChallenge() {
            gameActive = false;
            const isAdd = Math.random() > 0.5;
            let n1, n2, ans;
            if (isAdd) { ans = Math.floor(Math.random() * 16) + 4; n1 = Math.floor(Math.random() * (ans - 1)) + 1; n2 = ans - n1; } 
            else { n1 = Math.floor(Math.random() * 11) + 10; n2 = Math.floor(Math.random() * (n1 - 2)) + 1; ans = n1 - n2; }
            document.getElementById('mathQuestion').innerText = `${n1} ${isAdd ? '+' : '-'} ${n2} = ?`;
            const options = [ans];
            while(options.length < 4) { const fake = ans + (Math.floor(Math.random() * 8) - 4); if (fake >= 0 && fake <= 25 && !options.includes(fake)) options.push(fake); }
            options.sort(() => Math.random() - 0.5);
            const grid = document.getElementById('mathOptions'); grid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "bg-yellow-500 hover:bg-yellow-600 text-white text-3xl font-bold py-5 rounded-2xl shadow-lg transition transform active:scale-95";
                btn.innerText = opt;
                btn.onclick = () => { if (opt === ans) revive(); else { document.getElementById('mathRevivalScreen').classList.add('hidden'); gameOver(); } };
                grid.appendChild(btn);
            });
            document.getElementById('mathRevivalScreen').classList.remove('hidden');
        }

        function revive() {
            document.getElementById('mathRevivalScreen').classList.add('hidden');
            character.x = platforms[0].x + platforms[0].width - 50; character.y = canvas.height - PLATFORM_Y_OFFSET; character.targetX = character.x;
            stick.length = 0; stick.angle = -Math.PI / 2; stick.x = platforms[0].x + platforms[0].width;
            state = 'waiting'; gameActive = true; update();
        }

        function triggerCompletion() {
            state = 'congrats'; gameActive = false; document.getElementById('congratsScreen').classList.remove('hidden');
            for(let i=0; i<12; i++) { setTimeout(() => { createFirework(Math.random() * fwCanvas.width, Math.random() * fwCanvas.height/2.2); }, i * 300); }
            animateFireworksLoop();
        }

        function createFirework(x, y) {
            const colors = ['#fbbf24', '#f87171', '#60a5fa', '#4ade80', '#c084fc', '#ffffff'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            for(let i=0; i<50; i++) {
                const angle = (Math.PI * 2 / 50) * i; const speed = 4 + Math.random() * 8;
                fwParticles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, alpha: 1, color: color, size: 3 + Math.random() * 3 });
            }
        }

        function drawFireworks() {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            for(let i = fwParticles.length - 1; i >= 0; i--) {
                const p = fwParticles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.alpha -= 0.012;
                if (p.alpha <= 0) fwParticles.splice(i, 1);
                else { fwCtx.globalAlpha = p.alpha; fwCtx.fillStyle = p.color; fwCtx.beginPath(); fwCtx.arc(p.x, p.y, p.size, 0, Math.PI * 2); fwCtx.fill(); }
            }
            fwCtx.globalAlpha = 1;
        }

        function animateFireworksLoop() { if (state !== 'congrats') return; drawFireworks(); requestAnimationFrame(animateFireworksLoop); }

        function startGrowing() {
            if (state !== 'waiting' || !gameActive) return;
            isHolding = true; state = 'growing'; stick.x = platforms[0].x + platforms[0].width; stick.y = canvas.height - PLATFORM_Y_OFFSET;
            stick.length = 0; stick.angle = -Math.PI / 2; document.getElementById('hint').classList.add('opacity-0');
        }

        function stopGrowing() { if (!isHolding || state !== 'growing') return; isHolding = false; state = 'falling'; }

        window.addEventListener('mousedown', startGrowing); window.addEventListener('mouseup', stopGrowing);
        window.addEventListener('touchstart', (e) => { e.preventDefault(); startGrowing(); }); window.addEventListener('touchend', stopGrowing);

        function updateUI() { document.getElementById('currentScore').innerText = score; }

        function gameOver() {
            gameActive = false; document.getElementById('finalScore').innerText = `${score}/10`;
            document.getElementById('gameOverScreen').classList.remove('hidden'); document.getElementById('gameOverCard').classList.add('shake');
        }

        document.getElementById('startBtn').onclick = () => {
            document.getElementById('startScreen').classList.add('hidden'); document.getElementById('scoreBox').classList.remove('opacity-0');
            document.getElementById('hint').classList.remove('opacity-0'); gameActive = true; initGame(); update();
        };

        document.getElementById('retryBtn').onclick = () => {
            document.getElementById('gameOverScreen').classList.add('hidden'); document.getElementById('gameOverCard').classList.remove('shake');
            gameActive = true; initGame(); update();
        };

        document.getElementById('finalResetBtn').onclick = () => {
            document.getElementById('congratsScreen').classList.add('hidden'); initGame(); gameActive = true; update();
        };

        initGame(); draw();
    </script>
</body>
</html>
