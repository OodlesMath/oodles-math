<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../assets/brand.css">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lesson 16 ‚Ä¢ Mid-Module Assessment</title>
  <!-- Font Poppins: Clean and Modern -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    /* --- VIBRANT THEME FOR KIDS --- */
    :root{
      --bg-color: #fff9e6;
      --card-bg: #ffffff;
      --text: #4a4a4a;
      --c-blue: #4CC9F0;
      --c-pink: #F72585;
      --c-yellow: #FFD166;
      --c-green: #06D6A0;
      --c-purple: #7209B7;
      --c-orange: #fb8500;
      --shadow-color: rgba(0,0,0,0.15);
      --radius: 24px;
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; }
    
    body{
      font-family: "Poppins", sans-serif;
      color: var(--text);
      min-height: 100vh;
      background-color: var(--bg-color);
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(247, 37, 133, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(76, 201, 240, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 50% 50%, rgba(255, 209, 102, 0.15) 0%, transparent 30%);
      overflow-x: hidden;
    }

    .oodles-logo-container {
        position: fixed; top: 12px; left: 16px; z-index: 10;
        background: #fff; padding: 8px 16px; border-radius: 99px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        display: flex; align-items: center; gap: 8px;
        border: 2px solid var(--c-blue);
    }
    .oodles-logo-icon { font-size: 24px; animation: bounce 2s infinite; }
    .oodles-logo-text { font-size: 20px; font-weight: 900; color: var(--c-blue); letter-spacing: 1px; }
    
    @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }

    .wrap{
      max-width: 1100px; margin: 0 auto; padding: 80px 20px 20px;
      display:grid; grid-template-columns: 380px 1fr; gap: 24px; min-height: 100vh;
    }

    .card{
      background: var(--card-bg); border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow-color);
      border: 3px solid #fff; overflow: hidden; position: relative;
      display: flex; flex-direction: column; z-index: 1;
    }

    header{
      padding: 16px 20px; background: #fdfdfd; border-bottom: 2px dashed #eee;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .logo {
      width: 48px; height: 48px; border-radius: 16px;
      background: #e0f7fa; color: var(--c-blue);
      display: grid; place-items: center; font-size: 24px; border: 2px solid var(--c-blue);
    }
    .t b { display: block; font-size: 16px; color: var(--c-purple); }
    .t span { display: block; font-size: 13px; color: #888; font-weight: 700; }

    .chips { display: flex; gap: 8px; }
    .chip {
      background: var(--c-yellow); color: #7a5c00; border: 2px solid #f0b429;
      border-radius: 99px; padding: 6px 12px; font-size: 14px; font-weight: 800;
      box-shadow: 0 2px 0 rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px;
    }

    .left .body { padding: 20px; background: linear-gradient(to bottom, #fff, #f9f9f9); flex: 1; }
    .big { font-size: 20px; color: var(--c-pink); margin-bottom: 8px; font-weight: 900; }
    .sub { font-size: 14px; color: #666; font-weight: 600; line-height: 1.5; }

    .btnrow { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
    .btn {
      border: none; border-radius: 16px; padding: 12px 20px; font-size: 16px; font-weight: 800;
      cursor: pointer; transition: transform 0.1s; display: inline-flex; align-items: center;
      gap: 8px; position: relative; font-family: inherit;
    }
    .btn:active { transform: translateY(4px); box-shadow: none !important; }
    .btn.primary { background: var(--c-blue); color: white; box-shadow: 0 6px 0 #2a9ec2; }
    .btn.danger { background: var(--c-pink); color: white; box-shadow: 0 6px 0 #d90429; }
    .btn.ghost { background: #f1f5f9; color: #64748b; box-shadow: 0 6px 0 #cbd5e1; }
    .btn.flag-btn { color: #b45309; border: 2px solid #f59e0b; background: #fffbeb; box-shadow: 0 4px 0 #f59e0b; }

    .progress { margin-top: 20px; background: #fff; border: 2px solid #eee; border-radius: 20px; padding: 16px; }
    .meter { height: 16px; background: #eee; border-radius: 99px; overflow: hidden; border: 2px solid #e2e8f0; }
    .bar { height: 100%; width: 0%; background: repeating-linear-gradient(45deg, var(--c-green), var(--c-green) 10px, #4ade80 10px, #4ade80 20px); transition: width 0.4s; }
    .small { font-size: 13px; color: #64748b; font-weight: 700; }

    .skillbox { margin-top: 12px; display: grid; gap: 8px; }
    .skill { border: 2px solid #e2e8f0; border-radius: 12px; padding: 8px 12px; background: #fff; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .skill b { font-size: 14px; color: #334155; }
    .pill { font-size: 12px; padding: 4px 10px; border-radius: 99px; font-weight: 800; }
    .pill.ok { background: #dcfce7; color: #166534; }
    .pill.bad { background: #fee2e2; color: #991b1b; }
    .pill.mid { background: #fef3c7; color: #92400e; }

    .right .stage { padding: 20px; background: #ecfeff; flex: 1; display: flex; flex-direction: column;}
    .panel { background: #fff; border-radius: 24px; border: 4px solid var(--c-blue); padding: 20px; flex: 1; position: relative; box-shadow: 0 12px 0 rgba(76, 201, 240, 0.3); overflow-y: auto; }

    .qtop { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .qtitle { font-size: 18px; color: var(--c-blue); font-weight: 800; }
    .tag { background: var(--c-yellow); color: #854d0e; padding: 6px 12px; border-radius: 20px; font-weight: 800; font-size: 13px; }

    .question { background: #fff; border: 3px dashed #cbd5e1; border-radius: 20px; padding: 20px; margin-bottom: 20px; }
    .prompt { font-size: 22px; color: #1e293b; margin: 0; line-height: 1.4; font-weight: 800; }
    .hint { margin-top: 10px; color: #64748b; font-style: italic; font-weight: 600; display: block; }
    
    .speak-btn { width: 44px; height: 44px; background: var(--c-blue); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 20px; cursor: pointer; box-shadow: 0 4px 0 #2a9ec2; transition: 0.2s; flex-shrink: 0; display: inline-grid; vertical-align: middle; margin-left: 8px; }

    .choices { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    .choice { background: #fff; border: 3px solid #e2e8f0; border-radius: 20px; padding: 16px; font-size: 24px; color: #334155; font-weight: 900; min-height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 0 #cbd5e1; transition: 0.1s; font-family: inherit; }
    .choice svg { max-width: 60px; max-height: 60px; }
    .choice:hover:not(:disabled) { transform: translateY(-4px); border-color: var(--c-blue); }
    .choice.selected { border-color: var(--c-blue); background: #e0f2fe; color: var(--c-blue); box-shadow: 0 6px 0 #0284c7; }
    .choice:disabled { opacity: 1; border-width: 2px; }
    .choice.correct { background: #dcfce7; border-color: var(--c-green); color: var(--c-green); }
    .choice.wrong { background: #fee2e2; border-color: var(--c-pink); color: var(--c-pink); opacity: 0.7; }

    .nav { margin-top: 20px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .gridNav { margin-top: 20px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 12px; background: #f8fafc; border-radius: 16px; border: 2px solid #e2e8f0; }
    .nav-item { border: 2px solid #e2e8f0; background: #fff; border-radius: 12px; padding: 8px 0; font-weight: 800; cursor: pointer; font-size: 14px; color: #64748b; transition: .2s; font-family: inherit; }
    .nav-item.cur { border-color: var(--c-blue); background: #e0f2fe; color: var(--c-blue); transform: scale(1.1); }
    .nav-item.answered { background: var(--c-green); border-color: var(--c-green); color: white; }
    .nav-item.flag { border-color: var(--c-orange); background: #fff7ed; color: var(--c-orange); }

    .count-grid { background: #fffbeb; border: 3px solid #fcd34d; border-radius: 20px; padding: 15px; gap: 8px; margin-top: 10px; display: flex; flex-wrap: wrap; justify-content: center; }
    .count-item { font-size: 36px; cursor: pointer; transition: 0.2s; }

    .two-cols{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; align-items:center; }

    /* Number Bond Vertical Layout */
    .bond-container { display: flex; flex-direction: column; align-items: center; padding: 20px; position: relative; min-height: 250px; width: 100%; max-width: 300px; margin: 0 auto; }
    .bond-svg-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
    .bond-row-parts { display: flex; justify-content: space-around; width: 100%; margin-top: 10px; position: relative; z-index: 2; }
    .bond-circle { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #cbd5e1; background: #fff; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; padding: 8px; gap: 4px; box-shadow: 0 4px 0 #cbd5e1; }
    .bond-circle.part { border-color: var(--c-blue); box-shadow: 0 4px 0 #2a9ec2; }
    .bond-circle.whole { width: 100px; height: 100px; border-color: var(--c-purple); border-width: 5px; font-size: 44px; font-weight: 900; color: var(--c-purple); margin-top: 60px; position: relative; z-index: 2; box-shadow: 0 6px 0 #5b0792; }
    .bond-dot { width: 12px; height: 12px; background: var(--c-blue); border-radius: 50%; box-shadow: inset -2px -2px rgba(0,0,0,0.2); }

    .clock-container { display: flex; justify-content: center; width: 100%; margin: 20px 0; }
    .clock { width: 200px; height: 200px; border: 10px solid var(--c-blue); background: #fff; box-shadow: 0 8px 0 rgba(76, 201, 240, 0.3); border-radius: 50%; position: relative; flex-shrink: 0; }
    .clock .center { width:12px; height:12px; border-radius:50%; background:#334155; position:absolute; left:50%; top:50%; transform: translate(-50%,-50%); z-index: 10; }
    .hand { position:absolute; left:50%; top:50%; transform-origin: bottom center; border-radius: 99px; z-index: 4; }
    .hand.hour { background: var(--c-pink); width: 8px; height: 55px; }
    .hand.minute { background: var(--c-blue); width: 5px; height: 85px; }
    .tick { position:absolute; left:50%; top:50%; width:4px; height:10px; background: #cbd5e1; border-radius: 2px; }
    .num { font-size: 18px; color: #334155; font-weight: 900; position:absolute; left:50%; top:50%; transform: translate(-50%,-50%); }

    .reviewBox { width: 100%; text-align: left; border: 3px solid var(--c-purple); background: #f8fafc; border-radius: 16px; padding: 12px; margin-top: 16px; max-height: 400px; overflow-y: auto; }
    .reviewItem { padding: 12px; border-radius: 12px; background: #fff; border: 2px solid #f1f5f9; margin-bottom: 10px; }
    .okTxt { color: var(--c-green); font-weight: 800; }
    .badTxt { color: var(--c-pink); font-weight: 800; }

    .end { display: grid; place-items: center; text-align: center; height: 100%; padding: 20px; position: relative; }
    #fireworks { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

    @media (max-width: 900px){
      .wrap{ grid-template-columns: 1fr; }
      .choices { grid-template-columns: 1fr; }
      .two-cols { grid-template-columns: 1fr; gap: 20px; }
    }
  </style>
</head>

<body>
  <img src="../assets/logo-oodles-math.png" class="oodles-logo">
  <div class="oodles-logo-container">
    <div class="oodles-logo-icon">üç≠</div>
    <div class="oodles-logo-text">OODLES MATH</div>
  </div>
  
  <div class="wrap">
    <!-- SIDEBAR -->
    <section class="card left">
      <header>
        <div class="brand">
          <div class="logo">üìù</div>
          <div class="t"><b>Exam Mode</b><span>Mid-Module</span></div>
        </div>
        <div class="chips">
          <div class="chip" id="chipTimer">‚è± 08:00</div>
          <div class="chip" id="chipStatus">üß© 0/10</div>
        </div>
      </header>
      <div class="body">
        <div class="big">Math Assessment</div>
        <div class="sub">10 Questions ‚Ä¢ 8 Minutes.<br>Select the best answer. Good luck!</div>
        <div class="btnrow">
          <button class="btn primary" id="startBtn">‚ñ∂ Start</button>
          <button class="btn ghost" id="resetBtn">üîÑ Reset</button>
        </div>
        <div class="progress">
          <div class="row" style="display:flex; justify-content:space-between; margin-bottom:8px">
            <div class="small"><b>Progress</b></div>
            <div class="small" id="mini">Not started</div>
          </div>
          <div class="meter"><div class="bar" id="bar"></div></div>
        </div>
        <div class="progress" style="margin-top:12px">
          <div class="small" style="margin-bottom:8px"><b>Skill Breakdown</b></div>
          <div class="skillbox" id="skillBox"></div>
        </div>
      </div>
    </section>

    <!-- MAIN AREA -->
    <section class="card right">
      <header>
        <div class="brand">
          <div class="logo">üéØ</div>
          <div class="t"><b>Questions</b><span>Practice & Review</span></div>
        </div>
        <div class="chips">
          <div class="chip" id="chipScore">‚≠ê ‚Äî</div>
          <div class="chip" id="chipLevel">üè∑ ‚Äî</div>
        </div>
      </header>
      <div class="stage">
        <div class="panel">
          <div class="end" id="welcome">
            <div style="text-align:center;">
              <div style="font-size:80px; margin-bottom:10px;">üß†</div>
              <h2 style="font-size: 32px; color: var(--c-purple);">Mid-Module Assessment</h2>
              <p style="color: #666;">Press <b>Start</b> to begin the 10-question test.</p>
            </div>
          </div>

          <div id="quiz" style="display:none;">
            <div class="qtop">
              <div class="qtitle" id="qTitle">Question 1</div>
              <div class="tag" id="qTag">Counting</div>
            </div>
            <div class="question" id="qBox"></div>
            <div class="choices" id="choices"></div>
            <div class="nav">
              <button class="btn flag-btn" id="flagBtn">üö© Flag</button>
              <div style="display:flex; gap:10px;">
                <button class="btn ghost" id="prevBtn">‚Üê Prev</button>
                <button class="btn primary" id="nextBtn">Next ‚Üí</button>
              </div>
            </div>
            <div class="gridNav" id="gridNav"></div>
            <div class="nav" style="margin-top:10px; justify-content: flex-end;">
              <button class="btn danger" id="submitBtn">‚úÖ Submit Test</button>
            </div>
          </div>

          <div class="end" id="finish" style="display:none;">
            <canvas id="fireworks"></canvas>
            <div style="position:relative; z-index:2; background:rgba(255,255,255,0.9); padding:20px; border-radius:20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width:100%; max-width:500px;">
              <div style="font-size:60px; margin-bottom: 10px;">üèÜ</div>
              <h2 id="finalTitle" style="color: var(--c-blue);">Submitted!</h2>
              <p id="finalText">...</p>
              <div class="btnrow" style="justify-content:center;">
                <button class="btn primary" id="reviewBtn">üëÄ Review Answers</button>
                <button class="btn ghost" id="newBtn">‚ñ∂ Retry</button>
              </div>
              <div class="reviewBox" id="reviewBox" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function playTone(freq, type, duration, vol=0.1) {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + duration);
  }
  const sfxClick = () => playTone(400, 'sine', 0.1, 0.05);
  const sfxSelect = () => playTone(600, 'triangle', 0.1, 0.05);
  const sfxNav = () => playTone(300, 'sine', 0.1, 0.03);
  const sfxSubmit = () => { playTone(523, 'sine', 0.1); setTimeout(()=>playTone(659, 'sine', 0.1), 100); setTimeout(()=>playTone(1046, 'sine', 0.4), 200); };

  let fwLoop = null;
  const fwCanvas = document.getElementById("fireworks");
  const fwCtx = fwCanvas.getContext("2d");
  let particles = [];
  function resizeCanvas() { 
    if(fwCanvas.parentElement){
      fwCanvas.width = fwCanvas.parentElement.offsetWidth; 
      fwCanvas.height = fwCanvas.parentElement.offsetHeight; 
    }
  }
  function createFirework(x, y) {
    for (let i = 0; i < 40; i++) {
      const angle = (Math.PI * 2 * i) / 40; const speed = Math.random() * 4 + 2;
      particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, alpha: 1, color: `hsl(${Math.random()*360},100%,50%)`, decay: Math.random()*0.02 + 0.01 });
    }
  }
  function updateFireworks() {
    fwCtx.globalCompositeOperation = 'destination-out'; fwCtx.fillStyle = 'rgba(0,0,0,0.1)'; fwCtx.fillRect(0,0,fwCanvas.width,fwCanvas.height);
    fwCtx.globalCompositeOperation = 'source-over';
    if(Math.random() < 0.05) createFirework(Math.random()*fwCanvas.width, Math.random()*fwCanvas.height*0.5);
    for (let i = particles.length-1; i>=0; i--) {
      let p = particles[i]; p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.alpha -= p.decay;
      fwCtx.globalAlpha = p.alpha; fwCtx.fillStyle = p.color; fwCtx.beginPath(); fwCtx.arc(p.x, p.y, 2, 0, Math.PI*2); fwCtx.fill();
      if (p.alpha <= 0) particles.splice(i, 1);
    }
    fwLoop = requestAnimationFrame(updateFireworks);
  }
  const stopFireworks = () => { if(fwLoop) cancelAnimationFrame(fwLoop); fwCtx.clearRect(0,0,fwCanvas.width,fwCanvas.height); };

  function speak(text) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9; window.speechSynthesis.speak(u); } }
  const rand = (a,b)=> Math.floor(Math.random()*(b-a+1))+a;
  const shuffle = (arr)=> arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(x=>x.v);

  const SKILLS = [
    { key:"counting", name:"Counting & Comparing" }, { key:"ordinal", name:"Ordinal Numbers" },
    { key:"bonds", name:"Number Bonds" }, { key:"subtraction", name:"Subtraction" },
    { key:"time", name:"Time" }, { key:"shapes", name:"2D Shapes" },
    { key:"patterns", name:"Patterns" }, { key:"addition", name:"Addition Story" }
  ];

  const shapeSVG = {
    square: `<svg width="40" height="40" viewBox="0 0 40 40"><rect x="5" y="5" width="30" height="30" fill="var(--c-pink)" /></svg>`,
    circle: `<svg width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="var(--c-blue)" /></svg>`,
    triangle: `<svg width="40" height="40" viewBox="0 0 40 40"><polygon points="20,5 36,35 4,35" fill="var(--c-yellow)" /></svg>`
  };

  const builders = {
    qCounting: () => {
      const n = rand(1, 10); const item = ["üçé","‚≠ê","üéà","üçÑ","üç™"][rand(0,4)];
      let html = ""; for(let i=0; i<n; i++) html += `<div class="count-item">${item}</div>`;
      const pText = `How many ${item} can you count?`;
      return { skill:"counting", tag:"üî¢ Counting", prompt: pText, answer: String(n), choices: shuffle([String(n), String(n==10?9:n+1), String(n<2?3:n-1)]), html: `<div class="prompt">${pText}<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div><div class="count-grid">${html}</div>` };
    },
    qComparingSimple: () => {
      const n1 = rand(1, 10); let n2 = rand(1, 10); while(n2 === n1) n2 = rand(1, 10);
      const mode = rand(0,1); const ans = mode ? Math.max(n1, n2) : Math.min(n1, n2);
      const p = mode ? "Which number is bigger?" : "Which number is smaller?";
      return { skill:"counting", tag:"‚öñÔ∏è Comparing", prompt: p, answer: String(ans), choices: shuffle([String(n1), String(n2), String(rand(11,15))]), html: `<div class="prompt">${p}<span class="speak-btn" onclick="speak('${p}')">üîä</span></div><div style="display:flex;gap:20px;justify-content:center;margin-top:20px">${[n1,n2].map(n=>`<div style="font-size:48px;font-weight:900;border:3px solid var(--c-blue);padding:10px 25px;border-radius:20px;color:var(--c-blue)">${n}</div>`).join('')}</div>` };
    },
    qComparingSuper: () => {
      const mode = rand(0,1); const nums = []; while(nums.length<3){ let r=rand(1,10); if(!nums.includes(r)) nums.push(r); }
      const ans = mode ? Math.max(...nums) : Math.min(...nums);
      const p = mode ? "Which is the GREATEST?" : "Which is the SMALLEST?";
      return { skill:"counting", tag:"‚öñÔ∏è Comparing", prompt: p, answer: String(ans), choices: nums.map(String), html: `<div class="prompt">${p}<span class="speak-btn" onclick="speak('${p}')">üîä</span></div><div style="display:flex;gap:15px;justify-content:center;margin-top:20px">${nums.map(n=>`<div style="font-size:40px;font-weight:900;border:3px solid var(--c-blue);padding:8px 15px;border-radius:15px;color:var(--c-blue)">${n}</div>`).join('')}</div>` };
    },
    qOrdinal: () => {
      const animals = ["üê∂","üê±","üê∞","ü¶ä","üêº","üêØ","üê∏","ü¶Å","üêÆ","üê®"]; const pos = rand(1,10);
      const ord = ["1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th"][pos-1];
      const pText = `Which animal is in the ${ord} position from the left?`;
      return { skill:"ordinal", tag:"ü•á Ordinal", prompt: pText, answer: animals[pos-1], choices: shuffle([animals[pos-1], animals[(pos+2)%10], animals[(pos+5)%10]]), html: `<div class="prompt">Find the <span style="color:var(--c-pink)">${ord}</span> animal!<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div><div style="display:flex; justify-content:center; gap:5px; padding:15px; background:#f0f9ff; border-radius:12px; margin-top:10px; overflow-x:auto;">${animals.map(a=>`<span style="font-size:24px;margin:0 4px">${a}</span>`).join("")}</div>` };
    },
    qShapes: () => {
      const p = [{n:"Square",s:shapeSVG.square},{n:"Rectangle",s:`<svg width="40" height="40" viewBox="0 0 40 40"><rect x="5" y="10" width="30" height="20" fill="var(--c-blue)" /></svg>`},{n:"Triangle",s:shapeSVG.triangle},{n:"Circle",s:shapeSVG.circle}];
      const t = p[rand(0,3)];
      const pText = `Which shape is a ${t.n}?`;
      return { skill:"shapes", tag:"üìê 2D Shapes", prompt: pText, answer: t.s, choices: shuffle(p.map(x=>x.s)), html: `<div class="prompt">${pText}<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div>` };
    },
    qBonds: () => {
      const whole = rand(2,5); const p1 = rand(1, whole-1); const p2 = whole-p1;
      let d1="", d2=""; for(let i=0;i<p1;i++) d1+='<div class="bond-dot"></div>'; for(let i=0;i<p2;i++) d2+='<div class="bond-dot"></div>';
      const pText = "Count the dots and find the missing whole number.";
      return { 
        skill:"bonds", tag:"üîó Bonds", prompt: `Find the Whole!`, answer: String(whole), 
        choices: shuffle([String(whole), String(whole==5?3:5), String(whole==2?4:1)]), 
        html: `<div class="prompt">Find the Whole!<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div>
               <div class="bond-container">
                 <div class="bond-svg-container">
                   <svg width="100%" height="100%" viewBox="0 0 300 250">
                      <line x1="75" y1="45" x2="150" y2="150" stroke="#cbd5e1" stroke-width="5" />
                      <line x1="225" y1="45" x2="150" y2="150" stroke="#cbd5e1" stroke-width="5" />
                   </svg>
                 </div>
                 <div class="bond-row-parts">
                   <div class="bond-circle part">${d1}</div>
                   <div class="bond-circle part">${d2}</div>
                 </div>
                 <div class="bond-circle whole">?</div>
               </div>` 
      };
    },
    qSubtraction: () => {
      const tot = rand(3,5); 
      const sub = rand(1, tot-1); 
      const rem = tot-sub;
      const bS = tot === 1 ? "balloon" : "balloons";
      const fS = sub === 1 ? "balloon flies" : "balloons fly";
      const promptText = `There are ${tot} ${bS}. ${sub} ${fS} away. How many are left?`;
      let html = ""; for(let i=0; i<tot; i++) html += `<span class="count-item" onclick="this.style.opacity=this.style.opacity=='0.2'?'1':'0.2'; sfxClick();">üéà</span>`;
      return { 
        skill:"subtraction", 
        tag:"‚ûñ Subtraction", 
        prompt: promptText, 
        answer: String(rem), 
        choices: shuffle([String(rem), String(tot), String(rem==1?4:1)]), 
        html: `<div class="prompt">${promptText}<span class="speak-btn" onclick="speak('${promptText}')">üîä</span></div><div class="hint">Tap a balloon to dim it!</div><div class="count-grid" style="margin-top:15px;">${html}</div>` 
      };
    },
    qPatterns: () => {
      const type = rand(0,2); let seq, ans;
      const s = [shapeSVG.square, shapeSVG.circle, shapeSVG.triangle];
      if(type==0){ seq=[s[0],s[1],s[0],s[1],s[0]]; ans=s[1]; } 
      else if(type==1){ seq=[s[0],s[0],s[1],s[0],s[0]]; ans=s[1]; }
      else { seq=[s[0],s[1],s[2],s[0],s[1],s[2],s[0]]; ans=s[1]; }
      const pText = "Look at the pattern. What shape comes next?";
      return { skill:"patterns", tag:"üìà Patterns", prompt: `What comes next?`, answer: ans, choices: shuffle(s), html: `<div class="prompt">What comes next?<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div><div style="display:flex; justify-content:center; align-items:center; gap:10px; margin:25px 0;">${seq.join('')}<span style="font-size:36px;font-weight:900;color:var(--c-pink);margin-left:10px">?</span></div>` };
    },
    qTime: () => {
      const h = rand(1,12);
      const ticks = Array.from({length:12}, (_,i)=>`<div class="tick" style="transform:translate(-50%,-50%) rotate(${i*30}deg) translate(0,-85px);"></div>`).join("");
      const nums = Array.from({length:12}, (_,i)=>{ const n=i+1, deg=n*30, r=70; return `<div class="num" style="transform:translate(${Math.sin(deg*Math.PI/180)*r}px, ${-Math.cos(deg*Math.PI/180)*r}px) translate(-50%,-50%);">${n}</div>`; }).join("");
      const pText = "Look at the clock. What time is it?";
      return { skill:"time", tag:"üïí Time", prompt: pText, answer: `${h}:00`, choices: shuffle([`${h}:00`, `${(h%12)+1}:00`, `${h==1?12:h-1}:00`]), html: `<div class="prompt">What time is it?<span class="speak-btn" onclick="speak('${pText}')">üîä</span></div><div class="clock-container"><div class="clock">${ticks}${nums}<div class="hand hour" style="transform:translateX(-50%) translateY(-100%) rotate(${h*30}deg);"></div><div class="hand minute" style="transform:translateX(-50%) translateY(-100%) rotate(0deg);"></div><div class="center"></div></div></div>` };
    },
    qAdditionStory: () => {
      const a = rand(1, 3); const b = rand(1, 5-a); const sum = a+b;
      const isAreA = a === 1 ? "is" : "are"; const birdS_A = a === 1 ? "bird" : "birds";
      const birdS_B = b === 1 ? "bird" : "birds";
      const p = `There ${isAreA} ${a} ${birdS_A} on a branch. ${b} more ${birdS_B} fly in. How many now?`;
      let ha="", hb=""; 
      for(let i=0;i<a;i++) ha+=`<span class="count-item" style="filter:hue-rotate(90deg)">üê¶</span>`;
      for(let i=0;i<b;i++) hb+=`<span class="count-item">üê¶</span>`;
      return { skill:"addition", tag:"‚ûï Addition", prompt: p, answer: String(sum), choices: shuffle([String(sum), String(sum==5?4:5), String(sum==1?2:3)]), html: `<div class="prompt">Story Time!<span class="speak-btn" onclick="speak('${p}')">üîä</span></div><div style="font-size:16px; color:#555; margin:10px 0;">${p}</div><div style="display:flex; align-items:center; justify-content:center; gap:15px; background:#fdf2f8; padding:15px; border-radius:20px; border:2px solid #fbcfe8"><div style="display:flex;gap:5px">${ha}</div><div style="font-size:32px; font-weight:900; color:var(--c-pink)">+</div><div style="display:flex;gap:5px">${hb}</div></div>` };
    }
  };

  let QUESTIONS = [], current = 0, answers = [], flagged = new Set(), started = false, submitted = false, leftSec = 480, timerId = null;
  const dom = {}; ["startBtn","resetBtn","welcome","quiz","finish","qTitle","qTag","qBox","choices","prevBtn","nextBtn","flagBtn","submitBtn","gridNav","chipTimer","chipStatus","chipScore","chipLevel","mini","bar","skillBox","finalTitle","finalText","reviewBtn","newBtn","reviewBox"].forEach(id=>dom[id]=document.getElementById(id));

  function setStatus(){
    const done = answers.filter(x=>x && x.choice!=null).length;
    dom.chipStatus.textContent = `üß© ${done}/10`; dom.bar.style.width = `${done*10}%`;
    dom.mini.textContent = started ? `Progress: ${done}/10` : "Not started";
  }

  function renderQuestion(){
    const q = QUESTIONS[current]; dom.qTitle.textContent = `Question ${current+1}`; dom.qTag.textContent = q.tag; dom.qBox.innerHTML = q.html; dom.choices.innerHTML = "";
    q.choices.forEach(c=>{
      const btn = document.createElement("button"); btn.className = `choice ${!submitted && answers[current]?.choice === c ? 'selected' : ''} ${submitted && c === q.answer ? 'correct' : ''} ${submitted && answers[current]?.choice === c && c !== q.answer ? 'wrong' : ''}`;
      btn.innerHTML = c; btn.disabled = submitted;
      if(!submitted) btn.onclick = ()=> { sfxSelect(); answers[current] = {choice:c, correct:c===q.answer, skill:q.skill}; renderQuestion(); };
      dom.choices.appendChild(btn);
    });
    dom.flagBtn.textContent = flagged.has(current) ? "üö© Unflag" : "üö© Flag";
    dom.gridNav.innerHTML = "";
    for(let i=0; i<10; i++){
      const b = document.createElement("button"); b.className = `nav-item ${i===current?'cur':''} ${answers[i]?.choice?'answered':''} ${flagged.has(i)?'flag':''}`;
      b.textContent = i+1; b.onclick = ()=> { if(!submitted){ sfxNav(); current=i; renderQuestion(); } };
      dom.gridNav.appendChild(b);
    }
    setStatus();
  }

  dom.startBtn.onclick = () => {
    sfxClick(); QUESTIONS = [builders.qCounting(), builders.qComparingSimple(), builders.qComparingSuper(), builders.qOrdinal(), builders.qShapes(), builders.qBonds(), builders.qSubtraction(), builders.qPatterns(), builders.qTime(), builders.qAdditionStory()];
    answers = Array.from({length:10}, ()=>({choice:null, correct:false})); flagged = new Set(); current = 0; submitted = false; started = true; leftSec = 480;
    if(timerId) clearInterval(timerId); timerId = setInterval(()=>{ leftSec--; dom.chipTimer.textContent = `‚è± ${String(Math.floor(leftSec/60)).padStart(2,"0")}:${String(leftSec%60).padStart(2,"0")}`; if(leftSec<=0) submit(true); }, 1000);
    dom.welcome.style.display = dom.finish.style.display = "none"; dom.quiz.style.display = "block"; renderQuestion();
  };

  function submit(timer=false){
    if(submitted || !started) return; sfxSubmit(); submitted = true; clearInterval(timerId);
    const score = answers.filter(a=>a.correct).length; const lv = score>=9?"Excellent":score>=7?"Good":score>=5?"Developing":"Keep Trying";
    dom.chipScore.textContent = `‚≠ê Score: ${score}/10`; dom.chipLevel.textContent = `üè∑ Level: ${lv}`;
    dom.skillBox.innerHTML = "";
    SKILLS.forEach(s => {
      const qL = QUESTIONS.filter(q=>q.skill===s.key); if(!qL.length) return;
      const cor = qL.filter(q=>answers[QUESTIONS.indexOf(q)]?.correct).length; const p = Math.round(cor/qL.length*100);
      dom.skillBox.innerHTML += `<div class="skill"><div><b>${s.name}</b></div><div class="pill ${p>=100?'ok':p>=50?'mid':'bad'}">${p}%</div></div>`;
    });
    dom.quiz.style.display = "none"; dom.finish.style.display = "grid"; startFireworks();
    dom.finalTitle.textContent = timer ? "Time's up!" : "Test Complete!";
    dom.finalText.innerHTML = `Score: <b>${score}/10</b> (${score*10}%)<br>Level: <b>${lv}</b>`;
  }

  function startFireworks() { resizeCanvas(); particles = []; updateFireworks(); }
  dom.submitBtn.onclick = () => submit();
  dom.resetBtn.onclick = () => { location.reload(); };
  dom.prevBtn.onclick = () => { if(current>0){ current--; renderQuestion(); } };
  dom.nextBtn.onclick = () => { if(current<9){ current++; renderQuestion(); } };
  dom.flagBtn.onclick = () => { if(flagged.has(current)) flagged.delete(current); else flagged.add(current); renderQuestion(); };
  dom.newBtn.onclick = () => dom.startBtn.click();
  dom.reviewBtn.onclick = () => {
    if(dom.reviewBox.style.display === "none"){
      dom.reviewBox.innerHTML = QUESTIONS.map((q,i)=>`<div class="reviewItem"><b>Q${i+1} ‚Ä¢ ${q.tag}</b><p>${q.prompt}</p>Result: <span class="${answers[i].correct?'okTxt':'badTxt'}">${answers[i].correct?'Correct':'Wrong'}</span></div>`).join("");
      dom.reviewBox.style.display = "block"; dom.reviewBtn.textContent = "Hide Review";
    } else { dom.reviewBox.style.display = "none"; dom.reviewBtn.textContent = "Review Answers"; }
  };
  window.onload = resizeCanvas;
  window.onresize = resizeCanvas;
</script>
</body>
</html>
