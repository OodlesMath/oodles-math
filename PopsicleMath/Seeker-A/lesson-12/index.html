<!doctype html>
<html lang="en">
<head>
  <link rel="stylesheet" href="../assets/brand.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roll & Subtract!</title>
  <!-- Google Fonts: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #FF6B9D 0%, #FFA07A 50%, #FFD93D 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    * { box-sizing: border-box; }

    .game-wrapper {
      width: 100%;
      min-height: 100%;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .game-title {
      font-size: 40px;
      font-weight: 800;
      color: #fff;
      text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
      margin: 0 0 5px 0;
    }

    .round-counter {
      font-size: 20px;
      color: #ffd700;
      font-weight: bold;
      text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
      margin-bottom: 15px;
    }

    .game-container {
      background: white;
      border-radius: 25px;
      padding: 25px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .instruction-box {
      background: linear-gradient(135deg, #A8E6CF 0%, #6BCF7F 100%);
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .instruction-text {
      font-size: 18px;
      color: white;
      font-weight: 700;
      margin: 0;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }

    .speaker-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }

    .speaker-button:hover { transform: scale(1.1); }

    .dice {
      width: 90px;
      height: 90px;
      background: white;
      border: 5px solid #333;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      font-weight: bold;
      color: #ff6b6b;
      margin: 20px auto;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      cursor: default;
    }

    .dice.rolling { animation: diceRoll 0.5s infinite ease-in-out; }

    @keyframes diceRoll {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(15deg) scale(1.1); }
      50% { transform: rotate(-15deg) scale(0.9); }
      75% { transform: rotate(15deg) scale(1.1); }
    }

    .equation-box {
      background: linear-gradient(135deg, #C7CEEA 0%, #FFB6D9 100%);
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .equation {
      font-size: 36px;
      font-weight: 800;
      color: #333;
      margin: 0;
    }

    .frame-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      background: #f0f0f0;
      padding: 15px;
      border-radius: 15px;
      margin: 20px 0;
    }

    .cell {
      aspect-ratio: 1;
      background: white;
      border: 3px solid #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cell.active { border-color: #4CAF50; }
    .cell.crossed { background: #ffebee; position: relative; }
    .cell.crossed::before, .cell.crossed::after {
      content: '';
      position: absolute;
      width: 80%;
      height: 3px;
      background: #ff6b6b;
      top: 50%;
      left: 50%;
    }
    .cell.crossed::before { transform: translate(-50%, -50%) rotate(45deg); }
    .cell.crossed::after { transform: translate(-50%, -50%) rotate(-45deg); }

    .action-button {
      padding: 15px 35px;
      font-size: 20px;
      font-weight: 700;
      color: white;
      background: linear-gradient(135deg, #FFB347 0%, #FF6B6B 100%);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      transition: all 0.2s;
      margin: 10px auto;
      display: block;
    }

    .action-button:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    .action-button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .answer-options {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .answer-btn {
      width: 75px;
      height: 75px;
      font-size: 32px;
      font-weight: 800;
      color: white;
      background: linear-gradient(135deg, #FF6BCF 0%, #9D50FF 100%);
      border: none;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .answer-btn:hover { transform: translateY(-3px); }
    .answer-btn.correct { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .answer-btn.wrong { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); animation: shake 0.4s; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .feedback-box {
      text-align: center;
      padding: 15px;
      border-radius: 15px;
      margin: 15px 0;
      font-size: 20px;
      font-weight: 700;
      color: white;
      display: none;
    }

    .feedback-box.show { display: block; }
    .feedback-box.correct { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .feedback-box.wrong { background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%); }

    .gift-selection { margin-top: 20px; text-align: center; display: none; }
    .gift-boxes { display: flex; justify-content: center; gap: 20px; margin-top: 15px; }
    .gift-box { width: 90px; height: 90px; cursor: pointer; transition: transform 0.3s; }
    .gift-box:hover { transform: scale(1.15) translateY(-5px); }

    .game-complete { text-align: center; padding: 40px 20px; display: none; }
    .complete-title { font-size: 45px; color: #ffd700; font-weight: 800; text-shadow: 3px 3px 0px rgba(0,0,0,0.3); }

    .confetti {
      position: fixed; width: 10px; height: 10px; z-index: 100;
      animation: confettiFall 3s linear forwards;
    }
    @keyframes confettiFall {
      to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }

    .hidden { display: none !important; }
    @media (max-width: 600px) {
      .frame-grid { grid-template-columns: repeat(5, 1fr); }
      .game-title { font-size: 30px; }
      .answer-btn { width: 60px; height: 60px; font-size: 24px; }
    }

    .undo-btn {
      background: #94a3b8;
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      margin: 10px auto;
      display: block;
      box-shadow: 0 4px 0px #64748b;
    }
    .undo-btn:active { transform: translateY(2px); box-shadow: 0 2px 0px #64748b; }
    .undo-btn:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
<img src="../assets/logo-oodles-math.png" class="oodles-logo">
<div class="game-wrapper">
  <h1 class="game-title">Roll & Subtract!</h1>
  <div class="round-counter" id="roundDisplay">Round 1 of 10</div>

  <div class="game-container">
    <div class="instruction-box">
      <p id="instruction" class="instruction-text">Roll the dice to start!</p>
      <button onclick="speakInstruction()" class="speaker-button" title="Listen">üîä</button>
    </div>

    <!-- Phase 1: Dice Roll -->
    <div id="diceSection">
      <div id="dice" class="dice">üé≤</div>
      <button id="rollBtn" class="action-button" onclick="rollDice()">Roll the Dice!</button>
    </div>

    <!-- Phase 2: Solve -->
    <div id="solveSection" class="hidden">
      <div class="equation-box">
        <p class="equation" id="equationText">20 - ? = ?</p>
      </div>
      
      <p class="text-gray-600 font-bold mb-2">üëá Click the circles backward! üëá</p>
      <div id="frameGrid" class="frame-grid"></div>
      <button id="undoBtn" class="undo-btn" onclick="undoClick()">‚Ü© Undo last click</button>

      <div id="answerSection" class="hidden">
        <div class="answer-options" id="answerOptions"></div>
      </div>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="feedback-box"></div>

    <!-- Gift Selection -->
    <div id="giftSection" class="gift-selection">
      <h3 class="text-xl font-bold text-gray-700">Wonderful! Pick a mystery gift!</h3>
      <div class="gift-boxes" id="giftBoxesContainer">
        <!-- SVGs will be reset here each round -->
      </div>
    </div>

    <!-- Final Result -->
    <div id="resultSection" class="game-complete">
      <h2 class="complete-title">üéâ Game Complete! üéâ</h2>
      <p class="text-2xl font-bold text-white mt-4" id="finalScore" style="text-shadow: 2px 2px 0px rgba(0,0,0,0.3)">Score: 100/100</p>
      <div class="text-5xl mt-6 mb-8" id="stickerCollection"></div>
      <button class="action-button" onclick="location.reload()">Play Again!</button>
    </div>
  </div>
</div>

<script>
  let currentRound = 1;
  const totalRounds = 10;
  let score = 0;
  let minuend = 20;
  let subtrahend = 0;
  let clickedCount = 0;
  let clickHistory = [];
  let stickers = ["üåü", "üåà", "üöÄ", "üç¶", "üé®", "üèÜ", "ü¶Ñ", "üçï", "üé∏", "üíé", "üéà", "üç≠"];
  let myStickers = [];

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  function playTone(freq, duration, type = 'sine') {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
  }

  function createConfetti() {
    const colors = ['#ff6b6b', '#ffd700', '#4CAF50', '#667eea', '#FF6BCF'];
    for (let i = 0; i < 40; i++) {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + 'vw';
      c.style.top = '-20px';
      c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      c.style.transform = `rotate(${Math.random() * 360}deg)`;
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 3000);
    }
  }

  function speakInstruction() {
    const text = document.getElementById('instruction').innerText;
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'en-US';
    msg.rate = 0.9;
    window.speechSynthesis.speak(msg);
  }

  function resetGiftBoxes() {
    const container = document.getElementById('giftBoxesContainer');
    container.innerHTML = `
        <div class="gift-box" onclick="pickGift(this)">
          <svg viewBox="0 0 100 100"><rect x="10" y="40" width="80" height="50" fill="#ff6b6b" stroke="#333" stroke-width="2"/><rect x="10" y="30" width="80" height="15" fill="#ffd700" stroke="#333" stroke-width="2"/><rect x="45" y="30" width="10" height="60" fill="#ffd700" stroke="#333" stroke-width="2"/><path d="M50 30 Q30 10 20 30" fill="none" stroke="#ffd700" stroke-width="4"/><path d="M50 30 Q70 10 80 30" fill="none" stroke="#ffd700" stroke-width="4"/></svg>
        </div>
        <div class="gift-box" onclick="pickGift(this)">
          <svg viewBox="0 0 100 100"><rect x="10" y="40" width="80" height="50" fill="#4CAF50" stroke="#333" stroke-width="2"/><rect x="10" y="30" width="80" height="15" fill="#FFD700" stroke="#333" stroke-width="2"/><rect x="45" y="30" width="10" height="60" fill="#FFD700" stroke="#333" stroke-width="2"/><path d="M50 30 Q30 10 20 30" fill="none" stroke="#FFD700" stroke-width="4"/><path d="M50 30 Q70 10 80 30" fill="none" stroke="#FFD700" stroke-width="4"/></svg>
        </div>
        <div class="gift-box" onclick="pickGift(this)">
          <svg viewBox="0 0 100 100"><rect x="10" y="40" width="80" height="50" fill="#667eea" stroke="#333" stroke-width="2"/><rect x="10" y="30" width="80" height="15" fill="#FFD700" stroke="#333" stroke-width="2"/><rect x="45" y="30" width="10" height="60" fill="#FFD700" stroke="#333" stroke-width="2"/><path d="M50 30 Q30 10 20 30" fill="none" stroke="#FFD700" stroke-width="4"/><path d="M50 30 Q70 10 80 30" fill="none" stroke="#FFD700" stroke-width="4"/></svg>
        </div>
    `;
  }

  function initRound() {
    minuend = Math.floor(Math.random() * 11) + 10; // 10 to 20
    clickedCount = 0;
    clickHistory = [];
    resetGiftBoxes();
    
    document.getElementById('roundDisplay').innerText = `Round ${currentRound} of ${totalRounds}`;
    document.getElementById('instruction').innerText = "Roll the dice to start!";
    document.getElementById('diceSection').classList.remove('hidden');
    document.getElementById('solveSection').classList.add('hidden');
    document.getElementById('giftSection').style.display = 'none';
    document.getElementById('feedback').classList.remove('show');
    document.getElementById('dice').innerText = "üé≤";
    document.getElementById('rollBtn').disabled = false;
  }

  function rollDice() {
    const dice = document.getElementById('dice');
    const rollBtn = document.getElementById('rollBtn');
    rollBtn.disabled = true;
    dice.classList.add('rolling');
    playTone(200, 0.5, 'square');

    let counter = 0;
    const interval = setInterval(() => {
      dice.innerText = Math.floor(Math.random() * (minuend + 1));
      counter++;
      if (counter > 10) {
        clearInterval(interval);
        dice.classList.remove('rolling');
        subtrahend = Math.floor(Math.random() * (minuend + 1));
        dice.innerText = subtrahend;
        setTimeout(setupSolvePhase, 800);
      }
    }, 100);
  }

  function setupSolvePhase() {
    document.getElementById('diceSection').classList.add('hidden');
    document.getElementById('solveSection').classList.remove('hidden');
    document.getElementById('instruction').innerText = `Count backward ${subtrahend} circles!`;
    document.getElementById('equationText').innerText = `${minuend} - ${subtrahend} = ?`;
    
    const grid = document.getElementById('frameGrid');
    grid.innerHTML = "";
    grid.style.gridTemplateColumns = minuend > 10 ? "repeat(10, 1fr)" : `repeat(${minuend}, 1fr)`;

    for (let i = 0; i < minuend; i++) {
      const cell = document.createElement('div');
      cell.className = "cell active";
      cell.innerText = "‚≠ï";
      cell.id = `cell-${i}`;
      cell.onclick = () => handleCellClick(i);
      grid.appendChild(cell);
    }
    
    document.getElementById('answerSection').classList.add('hidden');
    document.getElementById('undoBtn').disabled = true;

    // FIX: N·∫øu tr·ª´ 0, hi·ªÉn th·ªã ngay c√°c l·ª±a ch·ªçn ƒë√°p √°n m√† kh√¥ng c·∫ßn click
    if (subtrahend === 0) {
      showAnswerOptions();
    }
  }

  function handleCellClick(index) {
    const targetIndex = (minuend - 1) - clickedCount;
    
    if (index === targetIndex) {
      const cell = document.getElementById(`cell-${index}`);
      cell.classList.remove('active');
      cell.classList.add('crossed');
      cell.innerText = "";
      clickHistory.push(index);
      clickedCount++;
      playTone(400 + (clickedCount * 60), 0.1);
      
      document.getElementById('undoBtn').disabled = false;

      // Hi·ªÉn th·ªã ƒë√°p √°n ngay khi ƒë·∫°t ho·∫∑c v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng c·∫ßn g·∫°ch
      if (clickedCount >= subtrahend) {
        showAnswerOptions();
      }
    } else {
      const fb = document.getElementById('feedback');
      fb.innerText = "Count backward from the last circle!";
      fb.className = "feedback-box show wrong";
      playTone(150, 0.2, 'sawtooth');
      setTimeout(() => fb.classList.remove('show'), 1500);
    }
  }

  function undoClick() {
    if (clickHistory.length === 0) return;
    
    const lastIndex = clickHistory.pop();
    const cell = document.getElementById(`cell-${lastIndex}`);
    cell.classList.add('active');
    cell.classList.remove('crossed');
    cell.innerText = "‚≠ï";
    clickedCount--;
    playTone(300, 0.1);

    if (clickHistory.length === 0) {
      document.getElementById('undoBtn').disabled = true;
    }

    // N·∫øu g·∫°ch ch∆∞a ƒë·ªß s·ªë l∆∞·ª£ng, ·∫©n ph·∫ßn ƒë√°p √°n
    if (clickedCount < subtrahend) {
      document.getElementById('answerSection').classList.add('hidden');
    }
  }

  function showAnswerOptions() {
    document.getElementById('answerSection').classList.remove('hidden');
    document.getElementById('instruction').innerText = "Great! How many are left?";
    const correct = minuend - subtrahend;
    const options = new Set([correct]);
    
    while (options.size < 3) {
      let wrong = Math.max(0, correct + (Math.floor(Math.random() * 7) - 3));
      if (wrong !== correct) options.add(wrong);
    }

    const sorted = Array.from(options).sort((a, b) => a - b);
    const container = document.getElementById('answerOptions');
    container.innerHTML = "";

    sorted.forEach(val => {
      const btn = document.createElement('button');
      btn.className = "answer-btn";
      btn.innerText = val;
      btn.onclick = () => checkAnswer(val, btn);
      container.appendChild(btn);
    });
  }

  function checkAnswer(val, btn) {
    const correct = minuend - subtrahend;
    const fb = document.getElementById('feedback');
    
    if (val === correct) {
      score += 10;
      btn.classList.add('correct');
      fb.innerText = "‚≠ê Brilliant! You got it! ‚≠ê";
      fb.className = "feedback-box show correct";
      playTone(800, 0.1);
      setTimeout(() => playTone(1200, 0.2), 100);
      createConfetti();
      
      setTimeout(() => {
        fb.classList.remove('show');
        document.getElementById('solveSection').classList.add('hidden');
        document.getElementById('giftSection').style.display = 'block';
      }, 1500);
    } else {
      btn.classList.add('wrong');
      fb.innerText = "Almost! Try counting again!";
      fb.className = "feedback-box show wrong";
      playTone(100, 0.3, 'sawtooth');
      setTimeout(() => {
        btn.classList.remove('wrong');
        fb.classList.remove('show');
      }, 1500);
    }
  }

  function pickGift(el) {
    // Disable other boxes
    const boxes = document.querySelectorAll('.gift-box');
    boxes.forEach(b => b.style.pointerEvents = 'none');

    const sticker = stickers[Math.floor(Math.random() * stickers.length)];
    el.innerHTML = `<div class="text-6xl animate-bounce">${sticker}</div>`;
    myStickers.push(sticker);
    playTone(1000, 0.5, 'triangle');
    
    setTimeout(() => {
      if (currentRound < totalRounds) {
        currentRound++;
        initRound();
      } else {
        showFinalResults();
      }
    }, 1500);
  }

  function showFinalResults() {
    document.getElementById('solveSection').classList.add('hidden');
    document.getElementById('giftSection').style.display = 'none';
    document.getElementById('roundDisplay').classList.add('hidden');
    document.querySelector('.instruction-box').classList.add('hidden');
    
    const res = document.getElementById('resultSection');
    res.style.display = 'block';
    document.getElementById('finalScore').innerText = `Final Score: ${score} / ${totalRounds * 10}`;
    document.getElementById('stickerCollection').innerText = myStickers.join(" ");
    createConfetti();
  }

  initRound();
</script>

</body>
</html>
